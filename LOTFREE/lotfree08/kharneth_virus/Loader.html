<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="fr">
<head>
<title>Rapport d'analyse pour le BugTraq#1 de ForumCrack par Kharneth</title>

	<link href="Asm.css" rel="stylesheet" type="text/css" />
	<link href="Style.css" rel="stylesheet" type="text/css" />

</head>
<body>

<div class="Sommaire"><a href="Index.html">Retour au sommaire</a></div>

<div class="Titre">IV. Analyse du loader</div>
				<ol>
<a name="ident"></a>						
						<li><span class="TitreSSChap">Identification de la cible</span>
								<p>Le fichier à analyser peut être téléchargé ici : <a target="blank" href="Cible/Virus.zip">Virus.zip</a>.</p>
								<p>Ce programme étant dangereux, je décide de l'étudier de manière statique à l'aide du désassembleur <a target="blank" href="http://www.programmersheaven.com/search/Download.asp?FileID=37637">IDA Freeware 4.3</a>. Ce qui est, de plus, une bonne occasion pour découvrir cet outil dont l'interface m'a toujours rebuté. Avant de commencer l'analyse, je préfère m'assurer que le PE Header n'a pa été altéré, pour éviter tout problème de chargement sous IDA. J'inspecte donc la structure du fichier à l'aide de <a target="blank" href="http://y0da.cjb.net/">Lord PE</a>.</p>								
								<div  style="border:1px solid #000;padding:5px;width:460px;">
								<table border="0" cellspacing="0">
								<tr><td class="LordPe">Name</td><td class="LordPe">VOffset</td><td class="LordPe">VSize</td><td class="LordPe">ROffset</td><td class="LordPe">RSize</td><td class="LordPe">Flags</td></tr>
								<tr style="background-color:#CCC;"><td>.text</td><td>00001000</td><td>00000826</td><td>00000000</td><td>00000000</td><td>E0000040</td></tr>
								<tr><td>.rdata</td><td>00002000</td><td>00000066</td><td>00000400</td><td>00000200</td><td>E0000040</td></tr>
								<tr><td>ZeGun0</td><td>00003000</td><td>00001000</td><td>00000600</td><td>00001000</td><td>E0000040</td></tr>
								<tr><td>ZeGun1</td><td>00004000</td><td>00001000</td><td>00001600</td><td>00000200</td><td>E0000040</td></tr>
								</table>
								</div>
								<p>								
									 Rien à signaler pour le PE Header, les valeurs semblent correctes.
									 La table d'import ne contient qu'une seule fonction, ce qui fait penser que les autres seront importées dynamiquement.
									 On remarque que les 2 champs ROffset et RSize de la première section sont nuls. De plus, l'EntryPoint se trouve dans la 3<sup>ème</sup> section (<span class="S2">00003010</span>) et les 4 sections autorisent l'accès en écriture (<i><span class="S2">E0000040</span> signifie que la section autorise l'accès en lecture, écriture et exécution</i>). C'est souvent le cas lorsqu'un programme est compressé/crypté.
								</p>								
						</li>
<a name="cida"></a><div class="SommaireR"><a href="Index.html">Retour au sommaire</a></div>							
						<li><span class="TitreSSChap">Chargement dans IDA</span>
								<p>On charge le programme dans IDA en laissant les options par défaut dans un premier temps, et première chose frappante, le code semble crypté après les 15 premières instructions.</p>
								<!--  Code XHTML généré par SciTE http://www.scintilla.org -->
								<div class="border" id="border">
								<span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00403010</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S9">public</span> <span class="S9">start</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00403010</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S9">start</span><span class="S4">:</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00403010</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">pusha</span>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="S1">; Sauvegarde des registres</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00403011</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">call</span> &nbsp;&nbsp;&nbsp;<span class="S10">$</span><span class="S4">+</span><span class="S2">5</span>&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="S1">; Place l'adresse 00403016</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00403016</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">pop</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">ebp</span>&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="S1">; dans EBP</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00403017</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">sub</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">ebp</span><span class="S4">,</span> <span class="S2">6</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="S1">; EBP = EntryPoint</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">0040301A</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">sub</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">ebp</span><span class="S4">,</span> <span class="S2">401010h</span> &nbsp;<span class="S1">; - le vrai EntryPoint du loader</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">0040301A</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="S1">; Pour caclculer le delta du code relogeable</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00403020</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">lea</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">ebx</span><span class="S4">,</span> <span class="S4">[</span><span class="S8">ebp</span><span class="S4">+</span><span class="S2">4016F8h</span><span class="S4">]</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00403026</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">mov</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">eax</span><span class="S4">,</span> <span class="S4">[</span><span class="S8">esp</span><span class="S4">-</span><span class="S2">10h</span><span class="S4">]</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">0040302A</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">mov</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S4">[</span><span class="S8">ebx</span><span class="S4">],</span> <span class="S8">eax</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">0040302C</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">lea</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">edi</span><span class="S4">,</span> <span class="S4">[</span><span class="S8">ebp</span><span class="S4">+</span><span class="S2">401042h</span><span class="S4">]</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00403032</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">lea</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">ecx</span><span class="S4">,</span> <span class="S4">[</span><span class="S8">ebp</span><span class="S4">+</span><span class="S2">401073h</span><span class="S4">]</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00403038</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">sub</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">ecx</span><span class="S4">,</span> <span class="S8">edi</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">0040303A</span> &nbsp;&nbsp;&nbsp;&nbsp;<br />
								ZeGun0<span class="S4">:</span><span class="S2">0040303A</span> &nbsp;&nbsp;&nbsp;&nbsp;Decrypt_Layer01<span class="S4">:</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; CODE XREF: ZeGun0:00403040</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">0040303A</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">add</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S4">[</span><span class="S8">edi</span><span class="S4">],</span> <span class="S8">cl</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">0040303C</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">xor</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S10">byte</span> <span class="S9">ptr</span> <span class="S4">[</span><span class="S8">edi</span><span class="S4">],</span> <span class="S2">0D2h</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">0040303F</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">inc</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">edi</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00403040</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">loop</span> &nbsp;&nbsp;&nbsp;Decrypt_Layer01<br />
								<span class="S1">;-------------------- Code crypté -----------------------------------------------------------------</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00403042</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S9">db</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S2">2Eh</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00403042</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">daa</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00403044</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">sub</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">al</span><span class="S4">,</span> <span class="S2">94h</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00403046</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S9">db</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S2">65h</span><br />
								</span>		
								</div>		
								<p>Les premières instructions sont typiques des loaders et permettent d'avoir un code indépendant de l'adressage. C'est à dire pouvant être exécuté à n'importe quel endroit (code relogeable). Au cours de l'exécution du programme, <span class="S8">ebp</span> contiendra un delta qui sera ajouté aux constantes pour pointer vers la bonne adresse. Ici, le delta est de <span class="S2">2000h</span> (403016 - 6 - 401010).</p>
								<p>Par exemple, en <span class="S2">0040302C</span>, l'adresse <span class="S2">00401042</span> est placée dans <span class="S8">edi</span>. <span class="S2">00401042</span> correspond à l'adresse d'une variable lorsque le loader a été assemblé. Pour retrouver la bonne adresse dans ce nouvel adressage, le delta est ajouté ce qui donne <span class="S2">00403042</span> (le début du code crypté).</p>
						</li>
<a name="sdelta"></a><div class="SommaireR"><a href="Index.html">Retour au sommaire</a></div>							
						<li><span class="TitreSSChap">Suppression du Delta</span>
								<p>Pour bénéficier pleinement de la puissance de IDA, il serait préférable d'avoir les adresses directement calculées avec le delta. Je suis d'abord parti sur un script IDC qui calculait les adresses avant de les patcher mais ce n'était pas très propre et un peu trop long à coder. Finalement, après une petite discussion avec Deicide et une profonde réflexion, j'ai trouvé une méthode beaucoup plus simple et efficace.</p>
								<p class="Ida"><img src="Images/Ida.png" alt="Ida" />On ferme IDA sans sauvegarder l'IDB et on recharge le programme mais cette fois en cochant <i><b>Manual Load</b></i>. Pour supprimer le delta, il suffit que la section du loader soit chargée à son adresse d'origine (<span class="S2">00401000</span>). Pour se faire, on va simplement retrancher le delta (<span class="S2">2000</span>) à l'ImageBase (<span class="S2">400000</span>). On entre donc dans le champ de IDA, la nouvelle ImageBase (<span class="S2">003FE000</span>) et on clique sur OK pour le reste.</p>
								<p>Maintenant que le delta (<span class="S8">ebp</span>) vaut <span class="S2">0</span>, on va pouvoir renommer les constantes en label. Voici la même partie de code maintenant plus compréhensible :</p>
								<div class="border" id="border">
								<span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00401010</span> &nbsp;&nbsp;&nbsp;&nbsp;<br />
								ZeGun0<span class="S4">:</span><span class="S2">00401010</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S9">public</span> <span class="S9">start</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00401010</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S9">start</span><span class="S4">:</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; DATA XREF: ZeGun0:0040101A</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00401010</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">pusha</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; Sauvegarde des registres</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00401011</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">call</span> &nbsp;&nbsp;&nbsp;<span class="S10">$</span><span class="S4">+</span><span class="S2">5</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; Calcul du delta pour le code relogeable</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00401016</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">pop</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">ebp</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; EBP = 00403016</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00401017</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">sub</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">ebp</span><span class="S4">,</span> <span class="S2">6</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; EBP = 00403010</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">0040101A</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">sub</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">ebp</span><span class="S4">,</span> <span class="S9">offset</span> <span class="S9">start</span> <span class="S1">; EBP = 00403010 - 00401010 = 2000 = Delta</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">0040101A</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; En modifiant l'ImageBase à 003FE000, Delta = 0</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00401020</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">lea</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">ebx</span><span class="S4">,</span> NTDLL_ImageBase<span class="S4">[</span><span class="S8">ebp</span><span class="S4">]</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00401026</span> &nbsp;&nbsp;&nbsp;&nbsp;<br />
								ZeGun0<span class="S4">:</span><span class="S2">00401026</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; Sous Win2000, [ESP-10h] contient l'ImageBase de NTDLL</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00401026</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">mov</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">eax</span><span class="S4">,</span> <span class="S4">[</span><span class="S8">esp</span><span class="S4">-</span><span class="S2">10h</span><span class="S4">]</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">0040102A</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">mov</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S4">[</span><span class="S8">ebx</span><span class="S4">],</span> <span class="S8">eax</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; ImageBase sauvegardée</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">0040102C</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">lea</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">edi</span><span class="S4">,</span> Layer01_Start<span class="S4">[</span><span class="S8">ebp</span><span class="S4">]</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00401032</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">lea</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">ecx</span><span class="S4">,</span> Layer01_End<span class="S4">[</span><span class="S8">ebp</span><span class="S4">]</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00401038</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">sub</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">ecx</span><span class="S4">,</span> <span class="S8">edi</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; ECX = Taille du Layer01 = 31h</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">0040103A</span> &nbsp;&nbsp;&nbsp;&nbsp;<br />
								ZeGun0<span class="S4">:</span><span class="S2">0040103A</span> &nbsp;&nbsp;&nbsp;&nbsp;DecryptLayer01<span class="S4">:</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; CODE XREF: ZeGun0:00401040</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">0040103A</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">add</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S4">[</span><span class="S8">edi</span><span class="S4">],</span> <span class="S8">cl</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">0040103C</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">xor</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S10">byte</span> <span class="S9">ptr</span> <span class="S4">[</span><span class="S8">edi</span><span class="S4">],</span> <span class="S2">0D2h</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">0040103F</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">inc</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">edi</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00401040</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">loop</span> &nbsp;&nbsp;&nbsp;DecryptLayer01<br />
								ZeGun0<span class="S4">:</span><span class="S2">00401042</span> &nbsp;&nbsp;&nbsp;&nbsp;<br />
								ZeGun0<span class="S4">:</span><span class="S2">00401042</span> &nbsp;&nbsp;&nbsp;&nbsp;Layer01_Start<span class="S4">:</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; DATA XREF: ZeGun0:0040102C</span><br />
								</span>								
								</div>	
						</li>			
<a name="layers"></a><div class="SommaireR"><a href="Index.html">Retour au sommaire</a></div>							
						<li><span class="TitreSSChap">Layers de cryptage</span>								
								<p>Juste après le cacul du delta, le programme sauvegarde la valeur contenue dans <span class="S4">[</span><span class="S8">esp</span><span class="S4">-</span><span class="S2">10h</span><span class="S4">]</span>. En regardant plusieurs programmes sous OllyDbg, j'ai remarqué que cette valeur est l'ImageBase de ntdll.dll sous Windows 2000 (mais pas sous XP).
								   S'ensuit une simple boucle (<b>DecryptLayer01</b>) qui décrypte les 49 octets de <b>Layer01_Start</b> (en 00401042) à <b>Layer01_End</b> (en 00401073).</p>
								<p>On ne peut pas continuer puisque le reste du code est crypté. On va donc le décrypter à l'aide d'un script IDC que voici :</p>
								<div class="border" id="border">
								<span><span class="S9">#include &lt;idc.idc&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S1">// Bibliothèque de fonctions</span><br />
								<br />
								<span class="S5">static</span><span class="S0"> </span>main<span class="S10">()</span><span class="S0"> </span><span class="S10">{</span><span class="S0">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S1">// Point d'entrée du script</span><br />
								<span class="S0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="S5">auto</span><span class="S0"> </span>J<span class="S10">,</span>address<span class="S10">,</span>count<span class="S10">;</span><span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S1">// Déclaration des variables</span><br />
								<span class="S0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>address<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span><span class="S4">0x401042</span><span class="S10">;</span><span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S1">// Adresse de début de décryptage</span><br />
								<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S1">// Décrypte 49 octets</span><br />
								<span class="S0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="S5">for</span><span class="S0"> </span><span class="S10">(</span>count<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span><span class="S4">0x31</span><span class="S10">;</span><span class="S0"> </span>count<span class="S10">&gt;</span><span class="S4">0</span><span class="S10">;</span><span class="S0"> </span>count<span class="S10">--)</span><span class="S0"> </span><span class="S10">{</span><br />
								<span class="S0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>J<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>Byte<span class="S10">(</span>address<span class="S10">);</span><span class="S0">&nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S1">// Récupère la valeur de l'octet à l'adresse courante</span><br />
								<span class="S0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>J<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>J<span class="S0"> </span><span class="S10">+</span><span class="S0"> </span>count<span class="S10">;</span><span class="S0">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S1">// Ajoute la valeur du compteur de boucle</span><br />
								<span class="S0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>J<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>J<span class="S0"> </span><span class="S10">^</span><span class="S0"> </span><span class="S4">0xD2</span><span class="S10">;</span><span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S1">// Xor 0D2h</span><br />
								<span class="S0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>PatchByte<span class="S10">(</span>address<span class="S10">,</span>J<span class="S10">);</span><span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S1">// Patche l'adresse avec l'octet décrypté</span><br />
								<span class="S0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>address<span class="S10">++;</span><span class="S0">&nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S1">// Octet suivant</span><br />
								<span class="S0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="S10">}</span><br />
								<span class="S0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>Message<span class="S10">(</span><span class="S6">"Layer décrypté\n"</span><span class="S10">);</span><br />
								<span class="S10">}</span><br />
								<span class="S0"></span></span>						
								</div>
								<p>Et voici le code fraichement décrypté et analysé (touche <b>C</b>) :</p
								<div class="border" id="border">
								<span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00401042</span> &nbsp;&nbsp;&nbsp;Layer01_Start<span class="S4">:</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; DATA XREF: ZeGun0:0040102C</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00401042</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">lea</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">eax</span><span class="S4">,</span> Layer02_Start<span class="S4">[</span><span class="S8">ebp</span><span class="S4">]</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00401048</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">lea</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">ecx</span><span class="S4">,</span> Layer02_End<span class="S4">[</span><span class="S8">ebp</span><span class="S4">]</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">0040104E</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">sub</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">ecx</span><span class="S4">,</span> <span class="S8">eax</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00401050</span> &nbsp;&nbsp;&nbsp;&nbsp;<br />
								ZeGun0<span class="S4">:</span><span class="S2">00401050</span> &nbsp;&nbsp;&nbsp;&nbsp;DecryptLayer02<span class="S4">:</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; CODE XREF: ZeGun0:00401068</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00401050</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">neg</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S10">byte</span> <span class="S9">ptr</span> <span class="S4">[</span><span class="S8">eax</span><span class="S4">]</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00401052</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">push</span> &nbsp;&nbsp;&nbsp;<span class="S8">eax</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00401053</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">add</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S10">byte</span> <span class="S9">ptr</span> <span class="S4">[</span><span class="S8">eax</span><span class="S4">],</span> <span class="S2">33h</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00401056</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">sub</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S10">byte</span> <span class="S9">ptr</span> <span class="S4">[</span><span class="S8">eax</span><span class="S4">],</span> <span class="S2">81h</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00401059</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">pop</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">eax</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">0040105A</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">sub</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S10">byte</span> <span class="S9">ptr</span> <span class="S4">[</span><span class="S8">eax</span><span class="S4">],</span> <span class="S2">0C3h</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">0040105D</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">push</span> &nbsp;&nbsp;&nbsp;<span class="S8">ecx</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">0040105E</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">neg</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S10">byte</span> <span class="S9">ptr</span> <span class="S4">[</span><span class="S8">eax</span><span class="S4">]</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00401060</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">ror</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S10">byte</span> <span class="S9">ptr</span> <span class="S4">[</span><span class="S8">eax</span><span class="S4">],</span> <span class="S2">2</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00401063</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">xor</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S4">[</span><span class="S8">eax</span><span class="S4">],</span> <span class="S8">cl</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00401065</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">pop</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">ecx</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00401066</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">inc</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">eax</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00401067</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">dec</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">ecx</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00401068</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">jnz</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S9">short</span> DecryptLayer02<br />
								ZeGun0<span class="S4">:</span><span class="S2">0040106A</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">mov</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">eax</span><span class="S4">,</span> <span class="S8">ebp</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">0040106C</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">add</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">eax</span><span class="S4">,</span> <span class="S9">offset</span> Layer02_Start<br />
								ZeGun0<span class="S4">:</span><span class="S2">00401071</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">push</span> &nbsp;&nbsp;&nbsp;<span class="S8">eax</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00401072</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">retn</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; Jmp Layer02_Start</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00401073</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; ---------------------------------------------------------------------------</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00401073</span> &nbsp;&nbsp;&nbsp;&nbsp;<br />
								ZeGun0<span class="S4">:</span><span class="S2">00401073</span> &nbsp;&nbsp;&nbsp;&nbsp;Layer01_End<span class="S4">:</span> &nbsp;&nbsp;<br />
								</span>
								</div>
								<p>Ce code est exécuté juste après la boucle de décryptage et se trouve être une nouvelle boucle qui va décrypter un autre bout de code.</p>
								<p>Le loader contient 15 couches de cryptage toutes différentes. Je ne vais pas les copier ici mais vous trouverez dans le dossier <a href="IDC/">IDC</a> les 15 scripts pour décrypter les 15 layers séparément.</p>
								<p>Après 5 couches de décryptage successives, la 6<sup>ème</sup> boucle va décrypter plusieurs fonctions utilitaires : une émulation de GetProcAddress, 3 fonctions pour résoudre les imports, et la fonction de décompression. Puis avant de sauter sur la prochaine boucle de décryptage, le loader récupère l'adresse de <b>IsDebuggerPresent</b> grâce à la fonction <b>GetProcAddress</b> émulée en <span class="S2">00401393</span>, avant de l'appeler. Si un debugger est détecté, le programme quitte. Je ne copie pas le code qui ne présente aucun intérêt particulier.</p>
						</li>
<a name="verif"></a><div class="SommaireR"><a href="Index.html">Retour au sommaire</a></div>						
						<li><span class="TitreSSChap">Vérification de la date</span>	
								<p>Après quelques décryptages supplémentaires, on arrive sur cette partie de code qui va vérifier la date du système. L'adresse de la fonction <b>GetSystemTime</b> est récupérée dynamiquement (toujours avec l'émulation de <b>GetProcAddress</b>) puis appélée. Cette fonction va remplir une structure <b>SYSTEMTIME</b> déclarée plus haut.</p>
								<p class="Ida"><img src="Images/Ida.png" alt="Ida" />Pour déclarer une structure dans IDA, on se place dans la fenêtre <b>Structures</b> (<i>Alt+9</i>) et on crée une nouvelle définition (<i>Inser</i>). Dans la boîte de dialogue, on clique sur <b>Add standard structure</b> puis on choisit dans la liste la structure qui nous intéresse (ici <b>SYSTEMTIME</b>). Il ne reste plus qu'à cliquer sur l'adresse représentant le début de la structure (<span class="S2">004011AC</span>) puis <i>Alt+Q</i> pour afficher la liste des structures disponibles et choisir <b>SYSTEMTIME</b>. Les membres sont renommés automatiquement dans tout le listing.</p>
								<div class="border" id="border">
								<span><br />
								ZeGun0<span class="S4">:</span><span class="S2">004011AC</span> &nbsp;&nbsp;&nbsp;&nbsp;SysTime &nbsp;&nbsp;&nbsp;<span class="S9">dw</span> <span class="S2">0</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; wYear</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">004011AC</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S9">dw</span> <span class="S2">0</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; wMonth</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">004011AC</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S9">dw</span> <span class="S2">0</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; wDayOfWeek</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">004011AC</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S9">dw</span> <span class="S2">0</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; wDay</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">004011AC</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S9">dw</span> <span class="S2">0</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; wHour</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">004011AC</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S9">dw</span> <span class="S2">0</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; wMinute</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">004011AC</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S9">dw</span> <span class="S2">0</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; wSecond</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">004011AC</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S9">dw</span> <span class="S2">0</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; wMilliseconds</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">004011BC</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; ---------------------------------------------------------------------------</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">004011BC</span> &nbsp;&nbsp;&nbsp;&nbsp;<br />
								ZeGun0<span class="S4">:</span><span class="S2">004011BC</span> &nbsp;&nbsp;&nbsp;&nbsp;GetTime<span class="S4">:</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; CODE XREF: ZeGun0:004011AA</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">004011BC</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">lea</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">eax</span><span class="S4">,</span> SysTime.wYear<span class="S4">[</span><span class="S8">ebp</span><span class="S4">]</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">004011C2</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">push</span> &nbsp;&nbsp;&nbsp;<span class="S8">eax</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">004011C3</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">call</span> &nbsp;&nbsp;&nbsp;Push_strGetSystemTime<br />
								ZeGun0<span class="S4">:</span><span class="S2">004011C3</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; ---------------------------------------------------------------------------</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">004011C8</span> &nbsp;&nbsp;&nbsp;&nbsp;str_Getsystemtime <span class="S9">db</span> <span class="S12">'GetSystemTime'</span><span class="S4">,</span><span class="S2">0</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">004011D6</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; ---------------------------------------------------------------------------</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">004011D6</span> &nbsp;&nbsp;&nbsp;&nbsp;<br />
								ZeGun0<span class="S4">:</span><span class="S2">004011D6</span> &nbsp;&nbsp;&nbsp;&nbsp;Push_strGetSystemTime<span class="S4">:</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; CODE XREF: ZeGun0:004011C3</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">004011D6</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">lea</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">ebx</span><span class="S4">,</span> Kernel32_ImageBase<span class="S4">[</span><span class="S8">ebp</span><span class="S4">]</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">004011DC</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">mov</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">ebx</span><span class="S4">,</span> <span class="S4">[</span><span class="S8">ebx</span><span class="S4">]</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">004011DE</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">push</span> &nbsp;&nbsp;&nbsp;<span class="S8">ebx</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">004011DF</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">lea</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">ebx</span><span class="S4">,</span> GetProcAddress<span class="S4">[</span><span class="S8">ebp</span><span class="S4">]</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">004011E5</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">call</span> &nbsp;&nbsp;&nbsp;<span class="S8">ebx</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">004011E7</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">call</span> &nbsp;&nbsp;&nbsp;<span class="S8">eax</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; Call GetSystemTime</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">004011E9</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">lea</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">eax</span><span class="S4">,</span> SysTime.wYear<span class="S4">[</span><span class="S8">ebp</span><span class="S4">]</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">004011EF</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">cmp</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S10">word</span> <span class="S9">ptr</span> <span class="S4">[</span><span class="S8">eax</span><span class="S4">],</span> <span class="S2">2011</span> <span class="S1">; Année = 2011</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">004011F4</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">jnz</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S9">short</span> Quit_BadDate<br />
								ZeGun0<span class="S4">:</span><span class="S2">004011F6</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">add</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">eax</span><span class="S4">,</span> <span class="S2">2</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; wMonth</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">004011F9</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">cmp</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S10">word</span> <span class="S9">ptr</span> <span class="S4">[</span><span class="S8">eax</span><span class="S4">],</span> <span class="S2">2</span> <span class="S1">; Mois = Février</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">004011FD</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">jnz</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S9">short</span> Quit_BadDate<br />
								ZeGun0<span class="S4">:</span><span class="S2">004011FF</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">add</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">eax</span><span class="S4">,</span> <span class="S2">4</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; wDay</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00401202</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">cmp</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S10">word</span> <span class="S9">ptr</span> <span class="S4">[</span><span class="S8">eax</span><span class="S4">],</span> <span class="S2">16</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00401206</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">jnz</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S9">short</span> Quit_BadDate <span class="S1">; Si la date du jour n'est pas le 16 février 2011, le programme quitte</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00401208</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">lea</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">edx</span><span class="S4">,</span> Layer08_End<span class="S4">[</span><span class="S8">ebp</span><span class="S4">]</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">0040120E</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">push</span> &nbsp;&nbsp;&nbsp;<span class="S8">edx</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">0040120F</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">retn</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; JMP Layer08_End</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00401210</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; ---------------------------------------------------------------------------</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00401210</span> &nbsp;&nbsp;&nbsp;&nbsp;<br />
								ZeGun0<span class="S4">:</span><span class="S2">00401210</span> &nbsp;&nbsp;&nbsp;&nbsp;Quit_BadDate<span class="S4">:</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; CODE XREF: ZeGun0:004011F4</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00401210</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; ZeGun0:004011FD</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00401210</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">popa</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00401211</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">retn</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00401212</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; ---------------------------------------------------------------------------</span><br />
								ZeGun0<span class="S4">:</span><span class="S2">00401212</span> &nbsp;&nbsp;&nbsp;&nbsp;<br />
								ZeGun0<span class="S4">:</span><span class="S2">00401212</span> &nbsp;&nbsp;&nbsp;&nbsp;Layer08_End<span class="S4">:</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; DATA XREF: ZeGun0:004010EE</span><br />
								</span>						
								</div>
								<p class="Warning"><img src="Images/Warning.png" alt="Ida" />Voici un point important. Le programme continuera son exécution uniquement si la date système est le <b>16 février 2011</b>.</p>
						 </li>		
<a name="decomp"></a><div class="SommaireR"><a href="Index.html">Retour au sommaire</a></div>							 
						 <li><span class="TitreSSChap">Décompression du code</span>	
						     <p>Les adresses des fonctions <b>LoadLibraryA</b>, <b>GetProcAddress</b> et <b>VirtualAlloc</b> (cette dernière n'est pas utilisée) sont récupérées de la manière suivante :</p>
								 <div class="border" id="border">						 		 
						 		 <span><br />
								 ZeGun0<span class="S4">:</span><span class="S2">004012A3</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">call</span> &nbsp;&nbsp;&nbsp;Push_StrLoadLibrayA<br />
								 ZeGun0<span class="S4">:</span><span class="S2">004012A3</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; ---------------------------------------------------------------------------</span><br />
								 ZeGun0<span class="S4">:</span><span class="S2">004012A8</span> &nbsp;&nbsp;&nbsp;&nbsp;str_Loadlibrarya <span class="S9">db</span> <span class="S12">'LoadLibraryA'</span><span class="S4">,</span><span class="S2">0</span><br />
								 ZeGun0<span class="S4">:</span><span class="S2">004012B5</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; ---------------------------------------------------------------------------</span><br />
								 ZeGun0<span class="S4">:</span><span class="S2">004012B5</span> &nbsp;&nbsp;&nbsp;&nbsp;<br />
								 ZeGun0<span class="S4">:</span><span class="S2">004012B5</span> &nbsp;&nbsp;&nbsp;&nbsp;Push_StrLoadLibrayA<span class="S4">:</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; CODE XREF: ZeGun0:004012A3</span><br />
								 ZeGun0<span class="S4">:</span><span class="S2">004012B5</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">lea</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">ebx</span><span class="S4">,</span> Kernel32_ImageBase<span class="S4">[</span><span class="S8">ebp</span><span class="S4">]</span><br />
								 ZeGun0<span class="S4">:</span><span class="S2">004012BB</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">mov</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">ebx</span><span class="S4">,</span> <span class="S4">[</span><span class="S8">ebx</span><span class="S4">]</span><br />
								 ZeGun0<span class="S4">:</span><span class="S2">004012BD</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">push</span> &nbsp;&nbsp;&nbsp;<span class="S8">ebx</span><br />
								 ZeGun0<span class="S4">:</span><span class="S2">004012BE</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">lea</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">ebx</span><span class="S4">,</span> GetProcAddress<span class="S4">[</span><span class="S8">ebp</span><span class="S4">]</span><br />
								 ZeGun0<span class="S4">:</span><span class="S2">004012C4</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">call</span> &nbsp;&nbsp;&nbsp;<span class="S8">ebx</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; GetProcAddress(hKernel32, "LoadLibraryA");</span><br />
								 ZeGun0<span class="S4">:</span><span class="S2">004012C6</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">lea</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">ebx</span><span class="S4">,</span> @LoadLibraryA<span class="S4">[</span><span class="S8">ebp</span><span class="S4">]</span><br />
								 ZeGun0<span class="S4">:</span><span class="S2">004012CC</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">mov</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S4">[</span><span class="S8">ebx</span><span class="S4">],</span> <span class="S8">eax</span><br />
								 </span>						 
						 		 </div>
								 <p>La fonction appelée ensuite ressemble fortement à la fonction <b>aP_depack_asm_fast</b> de <a target="blank" href="http://www.ibsensoftware.com/">aPLib</a>.</p>
								 <div class="border" id="border">		
								 <span><br />
								 ZeGun0<span class="S4">:</span><span class="S2">00401324</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">lea</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">edi</span><span class="S4">,</span> VOffset<span class="S4">[</span><span class="S8">ebp</span><span class="S4">]</span> <span class="S1">; VOffset de la 1ère section</span><br />
								 ZeGun0<span class="S4">:</span><span class="S2">0040132A</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">mov</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">edi</span><span class="S4">,</span> <span class="S4">[</span><span class="S8">edi</span><span class="S4">]</span><br />
								 ZeGun0<span class="S4">:</span><span class="S2">0040132C</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">lea</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">edx</span><span class="S4">,</span> ImageBase<span class="S4">[</span><span class="S8">ebp</span><span class="S4">]</span> <span class="S1">; + ImageBase</span><br />
								 ZeGun0<span class="S4">:</span><span class="S2">00401332</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">add</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">edi</span><span class="S4">,</span> <span class="S4">[</span><span class="S8">edx</span><span class="S4">]</span><br />
								 ZeGun0<span class="S4">:</span><span class="S2">00401334</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">push</span> &nbsp;&nbsp;&nbsp;<span class="S8">edi</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; Push VA 1ere section</span><br />
								 ZeGun0<span class="S4">:</span><span class="S2">00401335</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">lea</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">esi</span><span class="S4">,</span> PackedCode<span class="S4">[</span><span class="S8">ebp</span><span class="S4">]</span><br />
								 ZeGun0<span class="S4">:</span><span class="S2">0040133B</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">push</span> &nbsp;&nbsp;&nbsp;<span class="S8">esi</span><br />
								 ZeGun0<span class="S4">:</span><span class="S2">0040133C</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">call</span> &nbsp;&nbsp;&nbsp;aP_depack_asm_fast <span class="S1">; aP_depack_asm_fast(Source, Destination);</span><br />
								 </span>								 
								 </div>
								 <p>La première section <b>.text</b> est décompressée à sa place en <span class="S2">00401000</span>.</p>
						 </li>	
<a name="imports"></a><div class="SommaireR"><a href="Index.html">Retour au sommaire</a></div>							 		
						 <li><span class="TitreSSChap">Résolution des imports</span>
						 		 <p>Après avoir récupéré l'ImageBase de User32.dll, la fonction de résolution des imports est appelée. Celle-ci est très confuse du fait de nombreux JMP dans tous les sens. Elle a été découpée en plusieurs blocs qui ont ensuite été mélangés. Lorsque l'on a compris l'ordre d'exécution, elle ne pose pas de problèmes particuliers. A part une fonction que j'ai appelé <b>CheckKernelUser</b> car elle teste les ImageBases de Kernel32 et de User32. Cependant le résultat n'est pas utilisé. Le seul intérêt de cette fonction, à la fin, est qu'elle fait pointer le nom de la dll courante vers la suivante.</p>
								 <p>Ici, il n'y a qu'un seul import, <b>Kernel32.EraseTape</b>. On note également que le nom de l'api est décrypté (<span class="S6">xor</span> byte ptr [<span class="S8">edi</span>], <span class="S2">0C5h</span>) avant d'en déterminer l'adresse (<a href="IDC/DecryptImport.idc">script IDC</a> pour décrypter le nom de l'api).</p>
						 		 <div class="border" id="border">
								 <span><br />
								 ZeGun0<span class="S4">:</span><span class="S2">00401341</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">call</span> &nbsp;&nbsp;&nbsp;Push_strUser32_dll <span class="S1">; LoadLibraryA("User32.dll");</span><br />
								 ZeGun0<span class="S4">:</span><span class="S2">00401341</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; ---------------------------------------------------------------------------</span><br />
								 ZeGun0<span class="S4">:</span><span class="S2">00401346</span> &nbsp;&nbsp;&nbsp;&nbsp;str_User32_dll &nbsp;<span class="S9">db</span> <span class="S12">'User32.dll'</span><span class="S4">,</span><span class="S2">0</span><br />
								 ZeGun0<span class="S4">:</span><span class="S2">00401351</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; ---------------------------------------------------------------------------</span><br />
								 ZeGun0<span class="S4">:</span><span class="S2">00401351</span> &nbsp;&nbsp;&nbsp;&nbsp;<br />
								 ZeGun0<span class="S4">:</span><span class="S2">00401351</span> &nbsp;&nbsp;&nbsp;&nbsp;Push_strUser32_dll<span class="S4">:</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; CODE XREF: ZeGun0:00401341</span><br />
								 ZeGun0<span class="S4">:</span><span class="S2">00401351</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">call</span> &nbsp;&nbsp;&nbsp;<span class="S8">ss</span><span class="S4">:</span>LoadLibraryA<span class="S4">[</span><span class="S8">ebp</span><span class="S4">]</span> <span class="S1">; LoadLibraryA("User32.dll");</span><br />
								 ZeGun0<span class="S4">:</span><span class="S2">00401357</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">lea</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">ebx</span><span class="S4">,</span> User32_ImageBase<span class="S4">[</span><span class="S8">ebp</span><span class="S4">]</span><br />
								 ZeGun0<span class="S4">:</span><span class="S2">0040135D</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">mov</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S4">[</span><span class="S8">ebx</span><span class="S4">],</span> <span class="S8">eax</span><br />
								 ZeGun0<span class="S4">:</span><span class="S2">0040135F</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">lea</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">ebx</span><span class="S4">,</span> FixImports<span class="S4">[</span><span class="S8">ebp</span><span class="S4">]</span><br />
								 ZeGun0<span class="S4">:</span><span class="S2">00401365</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">call</span> &nbsp;&nbsp;&nbsp;<span class="S8">ebx</span><br />
								 </span>						 
								 </div>
						 </li>	
<a name="oep"></a><div class="SommaireR"><a href="Index.html">Retour au sommaire</a></div>							 
						 <li><span class="TitreSSChap">Saut sur l'OEP</span>
						 		 <p>L'<b>Original EntryPoint</b> est calculé simplement puis le loader patche l'adresse <span class="S2">0040138E</span> pour donner <span class="S6">push</span> <span class="S2">00401004h</span> et le <span class="S6">retn</span> saute sur l'OEP du programme démarrant ainsi l'exécution du virus. Juste avant de sauter, le loader restaure la valeur sauvegardé en début de programme.</p>
						 		 <div class="border" id="border">
								 <span><br />
								 ZeGun0<span class="S4">:</span><span class="S2">00401367</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">lea</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">eax</span><span class="S4">,</span> OriginalEntryPoint<span class="S4">[</span><span class="S8">ebp</span><span class="S4">]</span><br />
								 ZeGun0<span class="S4">:</span><span class="S2">0040136D</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">mov</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">eax</span><span class="S4">,</span> <span class="S4">[</span><span class="S8">eax</span><span class="S4">]</span><br />
								 ZeGun0<span class="S4">:</span><span class="S2">0040136F</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">add</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">eax</span><span class="S4">,</span> <span class="S8">ss</span><span class="S4">:</span>ImageBase<span class="S4">[</span><span class="S8">ebp</span><span class="S4">]</span> <span class="S1">; eax = OEP VA</span><br />
								 ZeGun0<span class="S4">:</span><span class="S2">00401375</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">lea</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">ebx</span><span class="S4">,</span> <span class="S4">(</span>OEPJmp<span class="S4">+</span><span class="S2">1</span><span class="S4">)[</span><span class="S8">ebp</span><span class="S4">]</span><br />
								 ZeGun0<span class="S4">:</span><span class="S2">0040137B</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">mov</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S4">[</span><span class="S8">ebx</span><span class="S4">],</span> <span class="S8">eax</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; Patche le PUSH pour le faire pointer sur l'OEP</span><br />
								 ZeGun0<span class="S4">:</span><span class="S2">0040137D</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">add</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">esp</span><span class="S4">,</span> <span class="S2">8</span><br />
								 ZeGun0<span class="S4">:</span><span class="S2">00401380</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">lea</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">ebx</span><span class="S4">,</span> NTDLL_ImageBase<span class="S4">[</span><span class="S8">ebp</span><span class="S4">]</span><br />
								 ZeGun0<span class="S4">:</span><span class="S2">00401386</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">mov</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">ebx</span><span class="S4">,</span> <span class="S4">[</span><span class="S8">ebx</span><span class="S4">]</span><br />
								 ZeGun0<span class="S4">:</span><span class="S2">00401388</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">mov</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S4">[</span><span class="S8">esp</span><span class="S4">-</span><span class="S2">10h</span><span class="S4">],</span> <span class="S8">ebx</span> &nbsp;<span class="S1">; Restaure la valeur sauvegardée au début</span><br />
								 ZeGun0<span class="S4">:</span><span class="S2">0040138C</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">popa</span><br />
								 ZeGun0<span class="S4">:</span><span class="S2">0040138D</span> &nbsp;&nbsp;&nbsp;&nbsp;<br />
								 ZeGun0<span class="S4">:</span><span class="S2">0040138D</span> &nbsp;&nbsp;&nbsp;&nbsp;OEPJmp<span class="S4">:</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; DATA XREF: ZeGun0:00401375</span><br />
								 ZeGun0<span class="S4">:</span><span class="S2">0040138D</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">push</span> &nbsp;&nbsp;&nbsp;<span class="S2">0</span><br />
								 ZeGun0<span class="S4">:</span><span class="S2">00401392</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">retn</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; JMP OEP</span><br />
								 </span>						 
								 </div>
								 <p>Vous trouverez la base <a href="IDB/">LoaderVirus.idb</a> du listing complet, décrypté et commenté dans le dossier IDB. </p>
						 </li>	
<a name="prog"></a><div class="SommaireR"><a href="Index.html">Retour au sommaire</a></div>							 
						 <li><span class="TitreSSChap">Programmation d'un décompresseur</span>
						     <p>D'après l'analyse, on a vu que le virus est simplement compressé avec aPLib. Le cryptage n'est là que pour le loader. La décompression sera donc simple.</p>
						 		 <p class="Ida"><img src="Images/Ida.png" alt="Ida" />On va d'abord copier la fonction de décompression depuis IDA en faisant menu <b>File</b> -> <b>Produce</b> -> <b>Create ASM file...</b>. On obtient un fichier asm contenant le listing complet de ida. Il ne reste plus qu'à copier la fonction <b>aP_depack_asm_fast</b> et la coller dans notre code (éventuellement corriger certaines lignes si l'assembleur n'est pas content, j'ai utilisé MASM).</p>
								 <p>Voici la structure de mon programme :
								 <ul>
								 		 <li>Ouvrir le fichier Virus.exe</li>
										 <li>Lire les données compressées</li>
										 <li>Décompresser les données</li>
										 <li>Copier l'intégralité du fichier virus.exe en mémoire</li>
										 <li>Corriger le PEHeader</li>
										 <li>Décrypter le nom de l'api importée</li>
										 <li>Créer un nouveau fichier</li>
										 <li>Ecrire le PEHeader corrigé</li>
										 <li>Ecrire la section décompressée</li>
										 <li>Ecrire le reste du fichier</li>
								 </ul>
								 </p>
								 <p>Voici les corrections apportées au PEHeader :</p>								 
								 <div class="border" id="border">
								 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="S6">Mov</span> <span class="S8">eax</span><span class="S4">,</span> NewFile<br />
								 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="S6">Lea</span> <span class="S8">edx</span><span class="S4">,</span> <span class="S10">Dword</span> <span class="S9">ptr</span> <span class="S4">[</span><span class="S8">eax</span><span class="S4">+</span><span class="S2">3Ch</span><span class="S4">]</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="S1">; edx = @PEHeader</span><br />
								 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="S6">Mov</span> <span class="S8">edx</span><span class="S4">,</span> <span class="S10">Dword</span> <span class="S9">ptr</span> <span class="S4">[</span><span class="S8">edx</span><span class="S4">]</span><br />
								 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="S6">Add</span> <span class="S8">edx</span><span class="S4">,</span> <span class="S8">eax</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="S1">; edx = PEHeader</span><br />
								 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="S6">Mov</span> <span class="S10">Dword</span> <span class="S9">ptr</span> <span class="S4">[</span><span class="S8">edx</span><span class="S4">+</span><span class="S2">28h</span><span class="S4">],</span> <span class="S2">1004h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="S1">; Corrige l'EntryPoint</span><br />
								 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="S6">Mov</span> <span class="S10">Dword</span> <span class="S9">ptr</span> <span class="S4">[</span><span class="S8">edx</span><span class="S4">+</span><span class="S2">80h</span><span class="S4">],</span> <span class="S2">2010h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="S1">; Corrige l'ImportDirectoryRVA</span><br />
								 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="S6">Add</span> <span class="S8">edx</span><span class="S4">,</span> <span class="S2">0F8h</span><br />
								 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="S6">Push</span> <span class="S10">Dword</span> <span class="S9">ptr</span> <span class="S4">[</span>UnpackedSize<span class="S4">]</span><br />
								 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="S6">Pop</span> <span class="S10">Dword</span> <span class="S9">ptr</span> <span class="S4">[</span><span class="S8">edx</span><span class="S4">+</span><span class="S2">10h</span><span class="S4">]</span>&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="S1">; Corrige la RSize de la 1ère section</span><br />
								 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="S6">Mov</span> <span class="S10">Dword</span> <span class="S9">ptr</span> <span class="S4">[</span><span class="S8">edx</span><span class="S4">+</span><span class="S2">14h</span><span class="S4">],</span> <span class="S2">400h</span>&nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; <span class="S1">; Corrige le ROffset de la 1ère section</span><br />
								 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="S6">Mov</span> <span class="S8">ebx</span><span class="S4">,</span> <span class="S4">[</span>UnpackedSize<span class="S4">]</span><br />
								 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="S6">Add</span> <span class="S8">edx</span><span class="S4">,</span> <span class="S2">28h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="S1">; Décale les sections suivantes pour prendre en compte</span><br />
								 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="S6">Add</span> <span class="S4">[</span><span class="S8">edx</span><span class="S4">+</span><span class="S2">14h</span><span class="S4">],</span> <span class="S8">ebx</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="S1">; la taille de la nouvelle section</span><br />
								 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="S6">Add</span> <span class="S8">edx</span><span class="S4">,</span> <span class="S2">28h</span><br />
								 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="S6">Add</span> <span class="S4">[</span><span class="S8">edx</span><span class="S4">+</span><span class="S2">14h</span><span class="S4">],</span> <span class="S8">ebx</span><br />
								 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="S6">Add</span> <span class="S8">edx</span><span class="S4">,</span> <span class="S2">28h</span><br />
								 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="S6">Add</span> <span class="S4">[</span><span class="S8">edx</span><span class="S4">+</span><span class="S2">14h</span><span class="S4">],</span> <span class="S8">ebx</span><br />
							 	 </div>
								 <p>Le code source du décompresseur est disponible dans le dossier <a href="Sources/Unpacker/">Sources/Unpacker/</a> </p>
						 </li>
				</ol>


<br />
<div class="Sommaire"><a href="Index.html">Retour au sommaire</a></div>


</body>
</html>
