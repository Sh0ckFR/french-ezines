
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>

<HEAD>
	<ME*TA HTTP-EQUIV="Content-Type" CONTENT="text/html;CHARSET=iso-8859-1">
	<ME*TA NAME="GENERATOR" Content="Visual Page 2.0 for Windows - Trial Version">
	<TITLE>PE File Format</TITLE>
</HEAD>

<BODY TEXT="#989FBC" BGCOLOR="black" LINK="#FFCC00" ALINK="red" VLINK="#FFCC00">

<P><A NAME="comp"></A><A NAME="header"></A><B><FONT COLOR="white" FACE="Arial Black">Le PE Header</FONT></B><FONT
SIZE="4" COLOR="white"> 
<HR ALIGN="CENTER">
</FONT></P>
<P><B><FONT COLOR="#FFCC00" FACE="Arial">PE File Format</FONT></B></P>
<P><B><U><FONT SIZE="2" FACE="Arial">Avant propos</FONT></U></B></P>
<P><FONT SIZE="2" FACE="Arial">De plus en plus il arrive que des protections renforc&eacute;es &quot;s'amusent&quot;
avec le PE Header, les tables d'Import, etc...</FONT></P>
<P><FONT SIZE="2" FACE="Arial">Loin de vouloir faire un tour exhaustif de la question, le texte qui suit se veut
juste une introduction &agrave; la comprehension de l'architecture du PE HEADER.</FONT></P>
<P><FONT SIZE="2" FACE="Arial"><BR>
</FONT><B><FONT SIZE="2" FACE="Arial">Le PE HEADER r&eacute;pond &agrave; une architecture de ce type:</FONT></B></P>
<CENTER>
<P>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" WIDTH="310">
	<TR>
		<TD WIDTH="187" VALIGN="TOP" BGCOLOR="#006666">
			<PRE ALIGN="CENTER"><FONT SIZE="2" COLOR="white" FACE="Arial">Dos-Stub</FONT></PRE>
		</TD>
		<TD><FONT SIZE="2" FACE="Arial">&nbsp;</FONT></TD>
	</TR>
	<TR>
		<TD WIDTH="187" VALIGN="TOP">
			<PRE ALIGN="CENTER"><FONT SIZE="2" COLOR="white" FACE="Arial">&nbsp;</FONT></PRE>
		</TD>
		<TD><FONT SIZE="2" FACE="Arial">&nbsp;</FONT></TD>
	</TR>
	<TR>
		<TD WIDTH="187" VALIGN="TOP" BGCOLOR="#006666">
			<PRE ALIGN="CENTER"><FONT SIZE="2" COLOR="white" FACE="Arial">File-Header</FONT></PRE>
		</TD>
		<TD><FONT SIZE="2" FACE="Arial">&nbsp;</FONT></TD>
	</TR>
	<TR>
		<TD WIDTH="187" VALIGN="TOP">
			<PRE ALIGN="CENTER"><FONT SIZE="2" COLOR="white" FACE="Arial">&nbsp;</FONT></PRE>
		</TD>
		<TD><FONT SIZE="2" FACE="Arial">&nbsp;</FONT></TD>
	</TR>
	<TR>
		<TD WIDTH="187" VALIGN="TOP" BGCOLOR="#006666">
			<PRE ALIGN="CENTER"><FONT SIZE="2" COLOR="white" FACE="Arial">Optional Header</FONT></PRE>
		</TD>
		<TD><FONT SIZE="2" FACE="Arial">&nbsp;</FONT></TD>
	</TR>
	<TR>
		<TD WIDTH="187" VALIGN="TOP">
			<PRE ALIGN="CENTER"><FONT SIZE="2" COLOR="white" FACE="Arial">&nbsp;</FONT></PRE>
		</TD>
		<TD><FONT SIZE="2" FACE="Arial">&nbsp;</FONT></TD>
	</TR>
	<TR>
		<TD WIDTH="187" VALIGN="TOP" BGCOLOR="#006666">
			<PRE ALIGN="CENTER"><FONT SIZE="2" COLOR="white" FACE="Arial">Data Directories</FONT></PRE>
		</TD>
		<TD><FONT SIZE="2" FACE="Arial">&nbsp;</FONT></TD>
	</TR>
	<TR>
		<TD WIDTH="187" VALIGN="TOP">
			<PRE ALIGN="CENTER"><FONT SIZE="2" COLOR="white" FACE="Arial">&nbsp;</FONT></PRE>
		</TD>
		<TD BGCOLOR="white">
			<P ALIGN="CENTER"><FONT SIZE="2" COLOR="black" FACE="Arial">RVA's to directories in sections</FONT>
		</TD>
	</TR>
	<TR>
		<TD WIDTH="187" VALIGN="TOP" BGCOLOR="#006666">
			<PRE ALIGN="CENTER"><FONT SIZE="2" COLOR="white" FACE="Arial">Sections headers</FONT></PRE>
		</TD>
		<TD><FONT SIZE="2" COLOR="black" FACE="Arial">&nbsp;</FONT></TD>
	</TR>
	<TR>
		<TD WIDTH="187" VALIGN="TOP">
			<PRE ALIGN="CENTER"><FONT SIZE="2" COLOR="white" FACE="Arial">&nbsp;</FONT></PRE>
		</TD>
		<TD BGCOLOR="white">
			<P ALIGN="CENTER"><FONT SIZE="2" COLOR="black" FACE="Arial">RVA's to section borders</FONT>
		</TD>
	</TR>
	<TR>
		<TD WIDTH="187" VALIGN="TOP" BGCOLOR="#006666">
			<PRE ALIGN="CENTER"><FONT SIZE="2" COLOR="white" FACE="Arial">Section 1</FONT></PRE>
		</TD>
		<TD><FONT SIZE="2" FACE="Arial">&nbsp;</FONT></TD>
	</TR>
	<TR>
		<TD WIDTH="187" VALIGN="TOP">
			<PRE ALIGN="CENTER"><FONT SIZE="2" COLOR="white" FACE="Arial">&nbsp;</FONT></PRE>
		</TD>
		<TD><FONT SIZE="2" FACE="Arial">&nbsp;</FONT></TD>
	</TR>
	<TR>
		<TD WIDTH="187" VALIGN="TOP" BGCOLOR="#006666">
			<PRE ALIGN="CENTER"><FONT SIZE="2" COLOR="white" FACE="Arial">...</FONT></PRE>
		</TD>
		<TD><FONT SIZE="2" FACE="Arial">&nbsp;</FONT></TD>
	</TR>
	<TR>
		<TD WIDTH="187" VALIGN="TOP">
			<PRE ALIGN="CENTER"><FONT SIZE="2" COLOR="white" FACE="Arial">&nbsp;</FONT></PRE>
		</TD>
		<TD><FONT SIZE="2" FACE="Arial">&nbsp;</FONT></TD>
	</TR>
	<TR>
		<TD WIDTH="187" VALIGN="TOP" BGCOLOR="#006666">
			<PRE ALIGN="CENTER"><FONT SIZE="2" COLOR="white" FACE="Arial">Section n</FONT></PRE>
		</TD>
		<TD><FONT SIZE="2" FACE="Arial">&nbsp;</FONT></TD>
	</TR>
</TABLE>
</P>
</CENTER>
<P><U><FONT SIZE="2" FACE="Arial">L'exemple de Notepad.exe (version Win 95)<BR>
</FONT></U><FONT SIZE="2" FACE="Arial"><BR>
Le PE HEADER commence en 0x00 par la compatibilit&eacute; MS-DOS: le MZ Header:</FONT></P>
<PRE><FONT SIZE="2" FACE="Courier New">00000000 </FONT><FONT SIZE="2" COLOR="blue" FACE="Courier New">4D5A</FONT><FONT
SIZE="2" FACE="Courier New"> 9000 0300 0000 0400 0000 FFFF 0000 MZ..............
00000010 B800 0000 0000 0000 4000 0000 0000 0000 ........@.......
00000020 0000 0000 0000 0000 0000 0000 0000 0000 ................
00000030 0000 0000 0000 0000 0000 0000 8000 0000 ................
00000040 0E1F BA0E 00B4 09CD </FONT><FONT SIZE="2" COLOR="blue" FACE="Courier New">21B8 014C</FONT><FONT SIZE="2"
FACE="Courier New"> CD21 5468 ........!..L.!Th
00000050 6973 2070 726F 6772 616D 2063 616E 6E6F is program canno
00000060 7420 6265 2072 756E 2069 6E20 444F 5320 t be run in DOS
00000070 6D6F 6465 2E0D 0D0A 2400 0000 0000 0000 mode....$.......</FONT></PRE>
<P><B><FONT SIZE="2" FACE="Courier New">MZ Header</FONT></B></P>
<PRE><B><FONT SIZE="2" FACE="Courier New"></FONT></B></PRE>
<P>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" WIDTH="91%">
	<TR>
		<TD WIDTH="61%">
			<PRE><FONT SIZE="2" FACE="Courier New">WORD e_magic;      &gt; Nombre Magique (</FONT><FONT SIZE="2" COLOR="blue"
			FACE="Courier New"> 4D5A </FONT><FONT SIZE="2" FACE="Courier New">) 
WORD e_cblp;       &gt; Bytes on last page of file 
WORD e_cp;         &gt; Pages in file 
WORD e_crlc;       &gt; Relocations 
WORD e_cparhdr;    &gt; Size of header in paragraphs 
WORD e_minalloc;   &gt; Minimum extra paragraphs needed 
WORD e_maxalloc;   &gt; Maximum extra paragraphs needed 
WORD e_ss;         &gt; Initial (relative) SS value 
WORD e_sp;         &gt; Initial SP value 
WORD e_csum;       &gt; Checksum 
WORD e_ip;         &gt; Initial IP value 
WORD e_cs;         &gt; Initial (relative) CS value 
WORD e_lfarlc;     &gt; File address of relocation table 
WORD e_ovno;       &gt; Overlay number 
WORD e_res[4];     &gt; Reserved words 
WORD e_oemid;      &gt; OEM identifier (for e_oeminfo) 
WORD e_oeminfo;    &gt; OEM information; e_oemid specific 
WORD e_res2[10];   &gt; Reserved words 
DWORD e_lfanew;    &gt; File address of new exe header </FONT></PRE>
		</TD>
		<TD WIDTH="39%" VALIGN="TOP">
			<PRE><FONT SIZE="2" FACE="Courier New">Address     Values     Meaning</FONT></PRE>

			<PRE><FONT SIZE="2" FACE="Courier New">
00000000     5A4D    Signature: MZ
00000002     0090    Extra Bytes
00000004     0003    Pages
00000006     0000    Reloc Items
00000008     0004    Header Size
0000000A     0000    Min Alloc
0000000C     FFFF    Max Alloc
0000000E     0000    Initial SS
00000010     00B8    Initial SP
00000012     0000    Check Sum
00000014     0000    Initial IP
00000016     0000    Initial CS
00000018     0040    Reloc Table
0000001A     0000    Overlay</FONT></PRE>
		</TD>
	</TR>
</TABLE>
</P>
<PRE></PRE>
<P><FONT SIZE="2" FACE="Arial">Le premier champ, e_magic est aussi appel&eacute; magic number.Ce champ est utilis&eacute;
pour identifier un type de fichier compatible MS-Dos. Tous les ex&eacute;cutables compatibles MS-Dos placent cette
valeur &agrave; 0x54AD, qui repr&eacute;sente le caract&egrave;re ASCII &quot;MZ&quot;. Le champ le plus important
pour Windows est le dernier: e_lfanew, indiquant &agrave; quel offset le PE Header est situ&eacute;.</FONT></P>
<P><B><U><FONT SIZE="2" FACE="Courier New">PE File Header:</FONT></U></B></P>
<PRE><FONT SIZE="2" FACE="Courier New">00000080 </FONT><FONT SIZE="2" COLOR="blue" FACE="Courier New">5045</FONT><FONT
SIZE="2" FACE="Courier New"> 0000 </FONT><FONT SIZE="2" COLOR="blue" FACE="Courier New">4C01</FONT><FONT SIZE="2"
FACE="Courier New"> 0600 </FONT><FONT SIZE="2" COLOR="blue" FACE="Courier New">8D54 F32F</FONT><FONT SIZE="2" FACE="Courier New"> 0000 0000 PE..L....T./....
00000090 0000 0000 </FONT><FONT SIZE="2" COLOR="blue" FACE="Courier New">E000</FONT><FONT SIZE="2" FACE="Courier New"> </FONT><FONT
SIZE="2" COLOR="red" FACE="Courier New">0E01</FONT><FONT SIZE="2" FACE="Courier New">                     ........
</FONT></PRE>
<P>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" WIDTH="89%">
	<TR>
		<TD WIDTH="60%">
			<PRE><FONT SIZE="2" FACE="Courier New">WORD   Machine Type                        ( </FONT><FONT SIZE="2" COLOR="blue"
			FACE="Courier New">014C</FONT><FONT SIZE="2" FACE="Courier New"> ) i386
WORD   Nombre de Sections                  ( 0006 ) 
DWORD  Time/Date                           ( </FONT><FONT SIZE="2" COLOR="blue" FACE="Courier New">2FF3548D</FONT><FONT
			SIZE="2" FACE="Courier New"> ) 
DWORD  Pointeur vers la table des Symboles ( 00000000 ) 
DWORD  Nombre de Symboles                  ( 00000000 ) 
WORD   Taille de l'Optional Header         ( </FONT><FONT SIZE="2" COLOR="blue" FACE="Courier New">00E0</FONT><FONT
			SIZE="2" FACE="Courier New"> ) 
WORD   Caracteristiques                    ( </FONT><FONT SIZE="2" COLOR="red" FACE="Courier New">010E</FONT><FONT
			SIZE="2" FACE="Courier New"> )</FONT></PRE>
		</TD>
		<TD WIDTH="40%">
			<PRE><FONT SIZE="2" FACE="Courier New">Address      Values        Meaning
00000080    00004550     Signature: PE
00000084        014C     Machine: 014C=I386
00000086        0005     Number of Sections
00000088    2FF3548D     Time/Date Stamp
0000008C    00000000     Pointer to Symbol Table
00000090    00000000     Number of Symbols
00000094        00E0     Optional Header Size
00000096        010E     Characteristics</FONT></PRE>
		</TD>
	</TR>
</TABLE>
</P>
<P><B><U><FONT SIZE="2" FACE="Courier New">PE Optional Header:</FONT></U></B></P>
<PRE><FONT SIZE="2" FACE="Courier New">Informations donn&eacute;es par un &eacute;diteur hexad&eacute;cimal</FONT></PRE>
<PRE><FONT SIZE="2" FACE="Courier New">00000090                     </FONT><FONT SIZE="2" COLOR="blue" FACE="Courier New">0B01</FONT><FONT
SIZE="2" FACE="Courier New"> 0232 003A 0000         ...2.:..
000000A0 </FONT><FONT SIZE="2" COLOR="blue" FACE="Courier New">004E 0000</FONT><FONT SIZE="2" FACE="Courier New"> 0006 0000 </FONT><FONT
SIZE="2" COLOR="blue" FACE="Courier New">0010 0000</FONT><FONT SIZE="2" FACE="Courier New"> 0010 0000 .N..............
000000B0 0050 0000 </FONT><FONT SIZE="2" COLOR="blue" FACE="Courier New">0000 4000</FONT><FONT SIZE="2" FACE="Courier New">                     .P....@.</FONT></PRE>
<PRE><FONT SIZE="2" FACE="Courier New">Informations donn&eacute;es par ProcDump</FONT></PRE>
<PRE><FONT SIZE="2" FACE="Courier New">Header lnfos
Entry Point :   </FONT><FONT SIZE="2" COLOR="blue" FACE="Courier New">00001000</FONT><FONT SIZE="2" FACE="Courier New">
Size of image : </FONT><FONT SIZE="2" COLOR="red" FACE="Courier New">0000D000</FONT><FONT SIZE="2" FACE="Courier New">
</FONT><FONT SIZE="2" COLOR="blue" FACE="Courier New">Image Base :    00400000</FONT></PRE>
<PRE><FONT SIZE="2" FACE="Courier New">
WORD    Magic                   ( </FONT><FONT SIZE="2" COLOR="blue" FACE="Courier New">010B</FONT><FONT SIZE="2"
FACE="Courier New"> ) 
BYTE    MajorLinkerVersion      ( 02 ) 
BYTE    MinorLinkerVersion      ( 32 ) 
DWORD   SizeOfCode              ( 00003A00 ) 
DWORD   SizeOfInitializedData   ( </FONT><FONT SIZE="2" COLOR="blue" FACE="Courier New">00004E00</FONT><FONT SIZE="2"
FACE="Courier New"> ) 
DWORD   SizeOfUninitializedData ( 00000600 ) 
</FONT><FONT SIZE="2" COLOR="blue" FACE="Courier New">DWORD   AddressOfEntryPoint     ( 00001000 )</FONT><FONT
SIZE="2" FACE="Courier New"> 
DWORD   BaseOfCode              ( 00001000 ) 
DWORD   BaseOfData              ( 00005000 )</FONT></PRE>
<PRE><FONT SIZE="2" COLOR="blue" FACE="Courier New">DWORD   ImageBase               ( 00004000</FONT><FONT SIZE="2"
FACE="Courier New"> )</FONT></PRE>
<PRE><FONT SIZE="2" FACE="Courier New"></FONT></PRE>
<PRE><FONT SIZE="2" FACE="Courier New">000000B0                     </FONT><FONT SIZE="2" COLOR="blue" FACE="Courier New">0010 0000</FONT><FONT
SIZE="2" FACE="Courier New"> 0002 0000         ........
000000C0 0100 0000 0000 0000 </FONT><FONT SIZE="2" COLOR="blue" FACE="Courier New">0400</FONT><FONT SIZE="2" FACE="Courier New"> 0000 0000 0000 ................
000000D0 </FONT><FONT SIZE="2" COLOR="blue" FACE="Courier New">00D0 0000</FONT><FONT SIZE="2" FACE="Courier New"> 0004 0000 197B 0100 0200 0000 .........{......
000000E0 </FONT><FONT SIZE="2" COLOR="blue" FACE="Courier New">0000</FONT><FONT SIZE="2" FACE="Courier New"> </FONT><FONT
SIZE="2" COLOR="blue" FACE="Courier New">1000 </FONT><FONT SIZE="2" FACE="Courier New">0010 0000 0000 1000 </FONT><FONT
SIZE="2" COLOR="blue" FACE="Courier New">0010 0000</FONT><FONT SIZE="2" FACE="Courier New"> ................
000000F0 0000 0000 </FONT><FONT SIZE="2" COLOR="blue" FACE="Courier New">1000 0000</FONT><FONT SIZE="2" FACE="Courier New">                     ........</FONT></PRE>
<PRE><FONT SIZE="2" FACE="Courier New">SectionAlignment            </FONT><FONT SIZE="2" COLOR="blue" FACE="Courier New">00 10 00 00</FONT><FONT
SIZE="2" FACE="Courier New"> ; 16-bytes-alignment
FileAlignment               00 20 00 00 ; 32-bytes-alignment
MajorOperatingSystemVersion 01 00       ; 
MinorOperatingSystemVersion 00 00       ;
MajorImageVersion           00 00       ; version 0.0
MinorImageVersion           00 00       ;
MajorSubsystemVersion       </FONT><FONT SIZE="2" COLOR="blue" FACE="Courier New">04 00</FONT><FONT SIZE="2" FACE="Courier New">       ; Win32 4.0
MinorSubsystemVersion       00 00       ;
Win32VersionValue           00 00 00 00 ; 
</FONT><FONT SIZE="2" COLOR="red" FACE="Courier New">SizeOfImage                 00 D0 00 00</FONT><FONT SIZE="2"
FACE="Courier New"> ; checksum
SizeOfHeaders               00 04 00 00 ; offset de la premi&egrave;re section
CheckSum                    19 7B 01 00 ; non utilis&eacute; pour les non-drivers
Subsystem                   02 00       ; Win32 console
DllCharacteristics          00 00       ; inutilis&eacute; (pas une DLL)
SizeOfStackReserve          </FONT><FONT SIZE="2" COLOR="blue" FACE="Courier New">00 00 10 00</FONT><FONT SIZE="2"
FACE="Courier New"> ; 1 MB stack
SizeOfStackCommit           00 10 00 00 ; 4 KB pour d&eacute;marrer
SizeOfHeapReserve           00 00 10 00 ; 1 MB heap
SizeOfHeapCommit            </FONT><FONT SIZE="2" COLOR="blue" FACE="Courier New">00 10 00 00</FONT><FONT SIZE="2"
FACE="Courier New"> ; 4 KB to start with
LoaderFlags                 00 00 00 00 ; 
NumberOfRvaAndSizes         </FONT><FONT SIZE="2" COLOR="blue" FACE="Courier New">10 00 00 00</FONT><FONT SIZE="2"
FACE="Courier New"> ; constant</FONT></PRE>
<P><FONT SIZE="2" FACE="Arial">A noter que l'alignement des sections n'est pas identique en RAM et sur le DD</FONT></P>
<P><FONT SIZE="2" FACE="Courier New">Informations donn&eacute;es par un &eacute;diteur hexad&eacute;cimal</FONT></P>
<PRE><FONT SIZE="2" FACE="Courier New">000000F0 0000 0000 1000 0000 </FONT><FONT SIZE="2" COLOR="red" FACE="Courier New">0000 0000 0000 0000</FONT><FONT
SIZE="2" FACE="Courier New"> ................
00000100 </FONT><FONT SIZE="2" COLOR="blue" FACE="Courier New">0070 0000 9A0C</FONT><FONT SIZE="2" FACE="Courier New"> </FONT><FONT
SIZE="2" COLOR="red" FACE="Courier New">0000 0080 0000 C830</FONT><FONT SIZE="2" FACE="Courier New"> 0000 .p...........0..
00000110 0000 0000 0000 0000 0000 0000 0000 0000 ................
00000120 </FONT><FONT SIZE="2" COLOR="blue" FACE="Courier New">00C0 0000 F407</FONT><FONT SIZE="2" FACE="Courier New"> </FONT><FONT
SIZE="2" COLOR="blue" FACE="Courier New">0000</FONT><FONT SIZE="2" FACE="Courier New"> 0000 0000 0000 0000 ................
00000130 0000 0000 0000 0000 0000 0000 0000 0000 ................
00000140 0000 0000 0000 0000 0000 0000 0000 0000 ................
00000150 0000 0000 0000 0000 0000 0000 0000 0000 ................
00000160 0000 0000 0000 0000 0000 0000 0000 0000 ................</FONT></PRE>
<P><FONT SIZE="2" FACE="Courier New">Informations donn&eacute;es par procdump:</FONT></P>
<P>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" WIDTH="58%">
	<TR>
		<TD WIDTH="59%" VALIGN="TOP">
			<PRE><FONT SIZE="2" FACE="Courier New">PE directory informations (HEX)

Export Table
Import Table
Resource
Exception
Security
Relocations
Debug Datas
Description
GIobal PTR
TLS table
Load Config
Bound Import
Import Address Table</FONT></PRE>
		</TD>
		<TD WIDTH="22%" VALIGN="TOP">
			<PRE><FONT SIZE="2" FACE="Courier New">
RVA
</FONT><FONT SIZE="2" COLOR="red" FACE="Courier New">00000000</FONT><FONT SIZE="2" FACE="Courier New">
</FONT><FONT SIZE="2" COLOR="blue" FACE="Courier New">00007000</FONT><FONT SIZE="2" FACE="Courier New">
</FONT><FONT SIZE="2" COLOR="red" FACE="Courier New">00008000</FONT><FONT SIZE="2" FACE="Courier New">
00000000
00000000
</FONT><FONT SIZE="2" COLOR="blue" FACE="Courier New">0000C000</FONT><FONT SIZE="2" FACE="Courier New">
00000000
00000000
00000000
00000000
00000000
00000000
00000000</FONT></PRE>
		</TD>
		<TD WIDTH="19%" VALIGN="TOP">
			<PRE><FONT SIZE="2" FACE="Courier New">
Size
</FONT><FONT SIZE="2" COLOR="red" FACE="Courier New">00000000</FONT><FONT SIZE="2" FACE="Courier New">
</FONT><FONT SIZE="2" COLOR="blue" FACE="Courier New">00000C9A</FONT><FONT SIZE="2" COLOR="red" FACE="Courier New">
000030C8</FONT><FONT SIZE="2" FACE="Courier New">
00000000
00000000
</FONT><FONT SIZE="2" COLOR="blue" FACE="Courier New">000007F4</FONT><FONT SIZE="2" FACE="Courier New">
00000000
00000000
00000000
00000000
00000000
00000000
00000000</FONT></PRE>
		</TD>
	</TR>
</TABLE>
</P>
<P><B><FONT SIZE="2" FACE="Courier New">Section Header</FONT></B></P>
<PRE><FONT SIZE="2" FACE="Courier New">00000170 0000 0000 0000 0000 </FONT><FONT SIZE="2" COLOR="blue" FACE="Courier New">2E74 6578</FONT><FONT
SIZE="2" FACE="Courier New"> </FONT><FONT SIZE="2" COLOR="blue" FACE="Courier New">7400</FONT><FONT SIZE="2" FACE="Courier New"> 0000 ........</FONT><FONT
SIZE="2" COLOR="blue" FACE="Courier New">.text</FONT><FONT SIZE="2" FACE="Courier New">...
00000180 </FONT><FONT SIZE="2" COLOR="blue" FACE="Courier New">5339 0000</FONT><FONT SIZE="2" FACE="Courier New"> </FONT><FONT
SIZE="2" COLOR="#990066" FACE="Courier New">0010 0000</FONT><FONT SIZE="2" FACE="Courier New"> </FONT><FONT SIZE="2"
COLOR="blue" FACE="Courier New">003A 0000</FONT><FONT SIZE="2" FACE="Courier New"> </FONT><FONT SIZE="2" COLOR="#990066"
FACE="Courier New">0004 0000</FONT><FONT SIZE="2" FACE="Courier New"> S9.......:......
00000190 0000 0000 0000 0000 0000 0000 </FONT><FONT SIZE="2" COLOR="blue" FACE="Courier New">2000 0060</FONT><FONT
SIZE="2" FACE="Courier New"> ............ ..`
000001A0 2E62 7373 0000 0000 3A04 0000 0050 0000 .bss....:....P..
000001B0 0001 0000 0000 0000 0000 0000 0000 0000 ................
000001C0 0000 0000 </FONT><FONT SIZE="2" COLOR="red" FACE="Courier New">8000 00C0</FONT><FONT SIZE="2" FACE="Courier New"> 2E64 6174 6100 0000 .........data...
000001D0 1202 0000 0060 0000 0004 0000 003E 0000 .....`.......&gt;..
000001E0 0000 0000 0000 0000 0000 0000 </FONT><FONT SIZE="2" COLOR="red" FACE="Courier New">4000 00C0</FONT><FONT
SIZE="2" FACE="Courier New"> ............@...
000001F0 2E69 6461 7461 0000 9A0C 0000 0070 0000 .idata.......p..
00000200 000E 0000 0042 0000 0000 0000 0000 0000 .....B..........
00000210 0000 0000 </FONT><FONT SIZE="2" COLOR="red" FACE="Courier New">4000 0040</FONT><FONT SIZE="2" FACE="Courier New"> 2E72 7372 6300 0000 ....@..@.rsrc...
00000220 0040 0000 0080 0000 0032 0000 0050 0000 .@.......2...P..
00000230 0000 0000 0000 0000 0000 0000 </FONT><FONT SIZE="2" COLOR="red" FACE="Courier New">4000 0040</FONT><FONT
SIZE="2" FACE="Courier New"> ............@..@
00000240 2E72 656C 6F63 0000 1E09 0000 00C0 0000 .reloc..........
00000250 000A 0000 0082 0000 0000 0000 0000 0000 ................
00000260 0000 0000 </FONT><FONT SIZE="2" COLOR="red" FACE="Courier New">4000 0042</FONT><FONT SIZE="2" FACE="Courier New"> 0000 0000 0000 0000 ....@..B........</FONT></PRE>
<PRE><FONT SIZE="2" FACE="Courier New">BYTE    Name[IMAGE_SIZEOF_SHORT_NAME]  ( </FONT><FONT SIZE="2" COLOR="blue"
FACE="Courier New">2E74 6578 7400</FONT><FONT SIZE="2" FACE="Courier New"> )
DWORD   PhysicalAddress 
DWORD   VirtualSize                    ( </FONT><FONT SIZE="2" COLOR="blue" FACE="Courier New">5339 0000</FONT><FONT
SIZE="2" FACE="Courier New"> )
DWORD   VirtualAddress                 ( 0010 0000 )
DWORD   SizeOfRawData                  ( </FONT><FONT SIZE="2" COLOR="blue" FACE="Courier New">003A 0000</FONT><FONT
SIZE="2" FACE="Courier New"> ) 
DWORD   PointerToRawData               ( 0004 0000</FONT><FONT SIZE="2" COLOR="blue" FACE="Courier New"> </FONT><FONT
SIZE="2" FACE="Courier New">) 
DWORD   PointerToRelocations
DWORD   PointerToLinenumbers 
WORD    NumberOfRelocations 
WORD    NumberOfLinenumbers 
DWORD   Caracteristiques               ( </FONT><FONT SIZE="2" COLOR="blue" FACE="Courier New">2000 0060 </FONT><FONT
SIZE="2" FACE="Courier New">) -&gt; </FONT><FONT SIZE="2" COLOR="red" FACE="Courier New">60000020</FONT></PRE>
<PRE><B><FONT SIZE="2" FACE="Courier New">Informations donn&eacute;es par Procdump:</FONT></B></PRE>
<PRE><FONT SIZE="2" FACE="Courier New">Sections lnformations :

 Name  Virtual Size  Virtual Off   Raw Size    Raw Offset Characterics
.text    </FONT><FONT SIZE="2" COLOR="#0066FF" FACE="Courier New">00003953</FONT><FONT SIZE="2" FACE="Courier New">     </FONT><FONT
SIZE="2" COLOR="#CC0099" FACE="Courier New">00001000</FONT><FONT SIZE="2" FACE="Courier New">     </FONT><FONT
SIZE="2" COLOR="blue" FACE="Courier New">00003A00</FONT><FONT SIZE="2" FACE="Courier New">     </FONT><FONT SIZE="2"
COLOR="#CC0099" FACE="Courier New">00000400</FONT><FONT SIZE="2" FACE="Courier New">    </FONT><FONT SIZE="2" COLOR="red"
FACE="Courier New">60000020</FONT><FONT SIZE="2" FACE="Courier New">
.bss     0000043A     00005000     00000100     00000000    </FONT><FONT SIZE="2" COLOR="red" FACE="Courier New">C0000080</FONT><FONT
SIZE="2" FACE="Courier New">
.data    00000212     00006000     00000400     00003E00    </FONT><FONT SIZE="2" COLOR="red" FACE="Courier New">C0000040</FONT><FONT
SIZE="2" FACE="Courier New">
.idata   00000C9A     00007000     00000E00     00004200    </FONT><FONT SIZE="2" COLOR="red" FACE="Courier New">40000040</FONT><FONT
SIZE="2" FACE="Courier New">
.rsrc    00004000     00008000     00003200     00005000    </FONT><FONT SIZE="2" COLOR="red" FACE="Courier New">40000040</FONT><FONT
SIZE="2" FACE="Courier New">
.reloc   0000091E     0000C000     00000A00     00008200    </FONT><FONT SIZE="2" COLOR="red" FACE="Courier New">42000040</FONT></PRE>
<PRE><FONT SIZE="2" COLOR="red" FACE="Courier New"></FONT></PRE>
<P><B><FONT SIZE="2" FACE="Courier New">Les caract&eacute;ristiques:</FONT></B></P>
<PRE><FONT SIZE="2" FACE="Courier New">  Valeur              Definition

  0x00000020          Code section
  0x00000040          Initialized data section
  0x00000080          Uninitialized data section
  0x04000000          Section cannot be cached
  0x08000000          Section is not pageable
  0x10000000          Section is shared
  0x20000000          Executable section
  0x40000000          Readable section
  0x80000000          Writable section</FONT></PRE>
<PRE><FONT SIZE="2" FACE="Courier New">(pour plus de d&eacute;tails voir  &quot;</FONT><A HREF="#Caractéristiques"><FONT
SIZE="2" FACE="Courier New">caract&eacute;ristiques du PE Header</FONT></A><FONT SIZE="2" FACE="Courier New">&quot;)</FONT></PRE>
<P><FONT SIZE="2" FACE="Arial">Notez qu'il y a une Section Header par section; &quot;Thus&quot;. Pour le PE Header
de Notepad.exe, il y aura 06 Sections Headers. Chaque section contient son nom en ASCII (ex: &quot;.text&quot;)
et un pointeur vers son emplacement; les headers ont une taille de 40 octets et il n'y a pas de &quot;padding&quot;
entre eux. Les sections qui sont habituellement pr&eacute;sentes dans un ex&eacute;cutable sont (sans &ecirc;tre
obligaoire):</FONT></P>
<PRE><FONT SIZE="2" FACE="Courier New">Executable Code Section:   .text 
Data Sections:             .data, .rdata, ou .bss 
Resources Section:         .rsrc 
Export Data Section:       .edata 
Import Data Section:       .idata 
Debug Information Section: .debug</FONT></PRE>
<P><B><FONT SIZE="2" FACE="Arial">Ex&eacute;cutable code section:</FONT></B><FONT SIZE="2" FACE="Arial"> .text
<BR>
Cette section contient le code du programme</FONT></P>
<P><B><FONT SIZE="2" FACE="Arial">Data sections:</FONT></B><FONT SIZE="2" FACE="Arial"> .bss, .rdata, .data <BR>
Il y a trois types de sections data: </FONT><FONT SIZE="2" COLOR="blue" FACE="Arial">.bss</FONT><FONT SIZE="2"
FACE="Arial">, qui contient des &quot;uninitialized data&quot; (incluant toutes les variables d&eacute;clar&eacute;es
et fixes), </FONT><FONT SIZE="2" COLOR="blue" FACE="Arial">.rdata</FONT><FONT SIZE="2" FACE="Arial">, qui contient
les &quot;read-only datas&quot; (comme les strings, et les constantes), et </FONT><FONT SIZE="2" COLOR="blue" FACE="Arial">.data</FONT><FONT
SIZE="2" FACE="Arial">, qui contient les variables globales ou le programme. Ces sections n'ont pas de r&eacute;elle
structure.</FONT><FONT SIZE="2" FACE="Courier New"><BR>
<BR>
</FONT><B><FONT SIZE="2" FACE="Arial">Ressources section:</FONT></B><FONT SIZE="2" FACE="Arial"> .rsrc <BR>
La section .rsrc contient toutes les ressources de l'application. Les 16 premiers octets de la section .rsrc contiennent
les Ressources du &quot;Directory Header&quot;:</FONT></P>
<PRE><FONT SIZE="2" FACE="Courier New"> Resource Directory 
 DWORD    Caracteristiques 
 DWORD    TimeDateStamp 
 WORD     MajorVersion 
 WORD     MinorVersion 
 WORD     NumberOfNamedEntries 
 WORD     NumberOfIdEntries  </FONT></PRE>
<P><FONT SIZE="2" FACE="Arial">Qui est imm&eacute;diatement suivie par le nombre d'entr&eacute;es sp&eacute;cifi&eacute;es
dans NumberOfNamedEntries + NumberOfIdEntries:</FONT></P>
<PRE><B><FONT SIZE="2" FACE="Courier New"> Resource Directory Entry </FONT></B><FONT SIZE="2" FACE="Courier New">
 DWORD    Name; 
 DWORD    OffsetToData;  </FONT></PRE>
<P><FONT SIZE="2" FACE="Arial">Le Nom d'une entr&eacute;e du Directory d&eacute;termine le type de la ressource,
pendant que l'Offset pointe vers une autre &quot;Ressource Directory Entry&quot; (la structure habituelle est une
Ressource Directory contenant la Ressource type point&eacute;e par une Ressource Directory (ou subdirectory) contenant
la Resource ID # et pointant vers l'entr&eacute;e des Ressources Datas), ou vers l'entr&eacute;e d'une Ressource
Data:</FONT></P>
<PRE><B><FONT SIZE="2" FACE="Courier New"> Resource Data Entry </FONT></B><FONT SIZE="2" FACE="Courier New">
 DWORD   OffsetToData; 
 DWORD   Size; 
 DWORD   CodePage; 
 DWORD   Reserved;  </FONT></PRE>
<P><FONT SIZE="2" FACE="Arial">L'entr&eacute;e de &quot;Resource Data&quot; contient la taille de l'actuelle Ressource
data, qui sera &agrave; terme une &quot;unicode string&quot; pour la String Table, et l'image binaire pour une
bitmap, ou une liste de valeurs et de strings pour une boite de dialogue. L'information sur le format du contenu
de la ressource binaire peut &ecirc;tre trouv&eacute;e dans &quot;Micro$oft's Win32 Binary Resource Formats.&quot;.
<BR>
<BR>
</FONT><B><FONT SIZE="2" FACE="Arial">La section Export data:</FONT></B><FONT SIZE="2" FACE="Arial"> .edata <BR>
La section .edata contient les &quot;exported data&quot; et les fonctions pour une application ou une librairie
(.DLL). La section commence avec le &quot;Export Directory&quot;:</FONT></P>
<PRE><FONT SIZE="2" FACE="Courier New"> </FONT><B><FONT SIZE="2" FACE="Courier New">Export Directory</FONT></B><FONT
SIZE="2" FACE="Courier New"> 
 DWORD   Characteristics; 
 DWORD   TimeDateStamp; 
 WORD    MajorVersion; 
 WORD    MinorVersion; 
 DWORD   Name; 
 DWORD   Base; 
 DWORD   NumberOfFunctions; 
 DWORD   NumberOfNames; 
 DWORD   *AddressOfFunctions; 
 DWORD   *AddressOfNames; 
 WORD    *AddressOfNameOrdinals;  </FONT></PRE>
<P><FONT SIZE="2" FACE="Arial">Les trois derniers champs contiennent les pointeurs vers la liste des points d'entr&eacute;
(Entry points) des fonctions export&eacute;es, la liste des noms des fonctions &quot;null-seperated&quot;, et la
liste des valeurs ordinales des fonctions. Ces pointeurs sont op&eacute;rationnels quand le programme est charg&eacute;
en m&eacute;moire. <BR>
<BR>
</FONT><B><FONT SIZE="2" FACE="Arial">Import data section:</FONT></B><FONT SIZE="2" FACE="Arial"> .idata <BR>
Cette section contient la liste des fonctions import&eacute;es dans le programme. Elle commence avec l'Import Directory:</FONT></P>
<PRE><B><FONT SIZE="2" FACE="Courier New">Import Directory </FONT></B><FONT SIZE="2" FACE="Courier New">
 DWORD    dwRVAFunctionNameList; 
 DWORD    dwUseless1; 
 DWORD    dwUseless2; 
 DWORD    dwRVAModuleName; 
 DWORD    dwRVAFunctionAddressList;  </FONT></PRE>
<P><FONT SIZE="2" FACE="Arial">Les deux derniers champs sont r&eacute;p&eacute;t&eacute;s pour chaque application
ou librairie que le programme importe. Dans un &eacute;diteur hexad&eacute;cimal vous pourrez voir en premier le
nom de la section d'un module donn&eacute;, le nom du module, puis toutes les fonctions import&eacute;es par ce
module.<BR>
La liste des imports est r&eacute;p&eacute;t&eacute;e jusqu'&agrave; une entr&eacute;e nulle.</FONT></P>
<P><U><FONT SIZE="2" FACE="Arial">A lire</FONT></U><FONT SIZE="2" FACE="Arial">: </FONT><A HREF="http://www.citeweb.net/christal/tutor/Import%20Function%20tutorial.zip"><FONT
SIZE="2" FACE="Arial">Import Data-Import Table Tutorial</FONT></A><FONT SIZE="2" FACE="Arial"> by el.CaRaCoL</FONT></P>
<P><FONT SIZE="2" FACE="Arial"><BR>
</FONT><B><FONT SIZE="2" FACE="Arial">Relative Virtual Addresses</FONT></B></P>
<P><FONT SIZE="2" FACE="Arial">La RVA (Relative Virtual Address) est utilis&eacute;e pour d&eacute;crire une adresse
m&eacute;moire si vous ne connaissez pas l'adresse base. C'est la valeur qui additionn&eacute;e &agrave; l'adresse
base va vous donner l'adresse r&eacute;elle telle que vous pourrez la lire dans un d&eacute;buggeur ou un d&eacute;sassembleur.<BR>
<BR>
Exemple: supposez qu'un fichier ex&eacute;cutable soit charg&eacute; &agrave; l'adresse 0x400000 et que son ex&eacute;cution
d&eacute;marre &agrave; RVA 0x1560. L'adresse de l'Entry Point de l'ex&eacute;cutable sera en 0x401560. Si l'ex&eacute;cutable
&eacute;tait charg&eacute; en 0x100000, l'Entry Point se situerait en 0x101560.<BR>
<BR>
Les choses commencent &agrave; se compliquer un peu si les sections ne sont pas align&eacute;es. Les sections d'un
fichier sont souvent align&eacute;es sur 512 octets, mais l'image charg&eacute;e peut &ecirc;tre align&eacute;es
sur 4096 octets...<BR>
<BR>
Aussi, pour trouver une adresse RVA pr&eacute;cise dans un fichier PE, vous devrez calculer l'offset d'o&ugrave;
le programme sera charg&eacute;.<BR>
<BR>
</FONT><B><FONT SIZE="2" FACE="Arial">La section Debug information:</FONT></B><FONT SIZE="2" FACE="Arial"> .debug
<BR>
Cette section contient les informations de d&eacute;buggage du programme, si le compilateur utilis&eacute; le permettait.
Elle commence par un &quot;Debug Directory&quot;:</FONT></P>
<PRE><B><FONT SIZE="2" FACE="Courier New">Debug Directory</FONT></B></PRE>
<PRE><FONT SIZE="2" FACE="Courier New">DWORD   Characteristics 
DWORD   TimeDateStamp 
WORD    MajorVersion 
WORD    MinorVersion 
DWORD   Type 
DWORD   SizeOfData 
DWORD   AddressOfRawData 
DWORD   PointerToRawData </FONT></PRE>
<P><B><FONT SIZE="2" FACE="Arial">Modification du PE Header: </FONT></B><FONT SIZE="2" FACE="Arial"><BR>
Puisque le PE Header donne l'adresse de d&eacute;part et la taille de chacune de ses diff&eacute;rentes sections
(et c'est le cas de la section .rsrc, la taille des datas), il est facile de modifier le contenu du PE Header en
ajustant l'offset du champ de chaque section suivant ce qui doit &ecirc;tre modifi&eacute;. Pour ajouter du code
suppl&eacute;mentaire vous pouvez agrandir la section .text mais vous aurez &agrave; corriger chacune des sections
suivantes; pour ajouter ou changer des ressources, il faudra modifier chaque subdirectory de la section .rsrc et
corriger toutes les sections qui viennent apr&egrave;s (c'est ainsi que Borland Resources Windows et les &eacute;diteurs
de ressources travaillent). Du coup il semble plus facile, plut&ocirc;t que de modifier chacune des sections, de
ne s'occuper que de la derni&egrave;re d'entre elles en l'agrandissant (ce qui au passage modifiera la taille de
l'application). Pourtant c'est la meilleurs et la plus rapide des m&eacute;thodes.</FONT></P>
<PRE><B><FONT SIZE="2" FACE="Arial">A lire:</FONT></B><FONT SIZE="2" FACE="Arial"> </FONT><A HREF="http://christal.citeweb.net/tutor/pe1.htm"
target="_blank"><FONT SIZE="2" FACE="Arial">Agrandir une section par Nody</FONT></A><FONT SIZE="2" FACE="Arial">
           </FONT><A HREF="modemploi.htm#IntroPlace" target="_blank"><FONT SIZE="2" FACE="Arial">Agrandir une section par TeeJi</FONT></A></PRE>
<P><BR>
<A NAME="Caractéristiques"></A><B><U><FONT SIZE="4" COLOR="white" FACE="Arial">Caract&eacute;ristiques des sections</FONT></U></B></P>
<P><BR>
<FONT SIZE="2" FACE="Arial">Voici quelques explications rapides et tr&egrave;s succinctes sur les attributs des
sections:<BR>
================<BR>
0x20...... : signifie eXecutable<BR>
0x40...... : signifie Readable<BR>
0x80...... : signifie Writeable<BR>
<BR>
exemple 0x60.. -&gt; eXecutable + Readable <BR>
0x60... -&gt; R-X-.<BR>
0xC0... -&gt; R-.-W<BR>
0xE0... -&gt; R-X-W<BR>
=================<BR>
0x......20 : signifie contains Code<BR>
0x......40 : signifie Initialized data<BR>
0x......80 : signifie Unitialized data<BR>
<BR>
0x......40 : la plupart des sections peuvent avoir cette valeur except&eacute; les sections CODE et .BSS<BR>
=================<BR>
Pour en savoir plus il existe un bon article r&eacute;cup&eacute;r&eacute; sur Microsoft.com appel&eacute; &quot;</FONT><A
HREF="http://mageos.ifrance.com/christal/PEformat.zip"><FONT SIZE="2" FACE="Arial">PEERING INSIDE the PE</FONT></A><FONT
SIZE="2" FACE="Arial">&quot; &eacute;crit en mars 94 par Matt Pietrek (qui travaille ou a travaill&eacute; chez..
chez... devinez: NU-MEGA TECHNOLOGIES INC.)</FONT></P>
<P ALIGN="RIGHT"><FONT SIZE="2" FACE="Arial">(contribution de Neutral AtomX)</FONT></P>
<P><U><FONT SIZE="2" FACE="Arial">Et pour ceux qui souhaitent plus de d&eacute;tails</FONT></U><FONT SIZE="2" FACE="Arial">
(extrait de Advanced Registry Tracer de Psych&eacute;)</FONT></P>
<P><FONT SIZE="2" FACE="Arial">// Section characteristics.</FONT></P>
<PRE><FONT SIZE="2" FACE="Courier New">#define IMAGE_SCN_TYPE_NO_PAD                0x00000008 // </FONT><FONT
SIZE="2" FACE="Arial">Reserved.</FONT><FONT SIZE="2" FACE="Courier New">
#define IMAGE_SCN_CNT_CODE                   0x00000020 // </FONT><FONT SIZE="2" FACE="Arial">Section contains code.</FONT><FONT
SIZE="2" FACE="Courier New">
#define IMAGE_SCN_CNT_INITIALIZED_DATA       0x00000040 // </FONT><FONT SIZE="2" FACE="Arial">Section contains initialized data.</FONT><FONT
SIZE="2" FACE="Courier New">
#define IMAGE_SCN_CNT_UNINITIALIZED_DATA     0x00000080 // </FONT><FONT SIZE="2" FACE="Arial">Section contains uninitialized data.</FONT><FONT
SIZE="2" FACE="Courier New">
#define IMAGE_SCN_LNK_OTHER                  0x00000100 // </FONT><FONT SIZE="2" FACE="Arial">Reserved.</FONT><FONT
SIZE="2" FACE="Courier New">
#define IMAGE_SCN_LNK_INFO                   0x00000200 // C</FONT><FONT SIZE="2" FACE="Arial">ontains comments or some other  info</FONT><FONT
SIZE="2" FACE="Courier New">
#define IMAGE_SCN_LNK_REMOVE                 0x00000800 // </FONT><FONT SIZE="2" FACE="Arial">Contents will not become part of image.</FONT><FONT
SIZE="2" FACE="Courier New">
#define IMAGE_SCN_LNK_COMDAT                 0x00001000 // </FONT><FONT SIZE="2" FACE="Arial">Section contents comdat.</FONT><FONT
SIZE="2" FACE="Courier New">
#define IMAGE_SCN_NO_DEFER_SPEC_EXC          0x00004000 // </FONT><FONT SIZE="2" FACE="Arial">Reset speculative exceptions handling</FONT><FONT
SIZE="2" FACE="Courier New">
#define IMAGE_SCN_GPREL                      0x00008000 // </FONT><FONT SIZE="2" FACE="Arial">Section content can be accessed  to GP</FONT><FONT
SIZE="2" FACE="Courier New">
#define IMAGE_SCN_MEM_FARDATA                0x00008000
#define IMAGE_SCN_MEM_PURGEABLE              0x00020000
#define IMAGE_SCN_MEM_16BIT                  0x00020000
#define IMAGE_SCN_MEM_LOCKED                 0x00040000
#define IMAGE_SCN_MEM_PRELOAD                0x00080000
#define IMAGE_SCN_ALIGN_1BYTES               0x00100000 
#define IMAGE_SCN_ALIGN_2BYTES               0x00200000 
#define IMAGE_SCN_ALIGN_4BYTES               0x00300000 
#define IMAGE_SCN_ALIGN_8BYTES               0x00400000 
#define IMAGE_SCN_ALIGN_16BYTES              0x00500000 // </FONT><FONT SIZE="2" FACE="Arial">Default alignment if no others specified.</FONT><FONT
SIZE="2" FACE="Courier New">
#define IMAGE_SCN_ALIGN_32BYTES              0x00600000 
#define IMAGE_SCN_ALIGN_64BYTES              0x00700000 
#define IMAGE_SCN_ALIGN_128BYTES             0x00800000 
#define IMAGE_SCN_ALIGN_256BYTES             0x00900000 
#define IMAGE_SCN_ALIGN_512BYTES             0x00A00000 
#define IMAGE_SCN_ALIGN_1024BYTES            0x00B00000 
#define IMAGE_SCN_ALIGN_2048BYTES            0x00C00000 
#define IMAGE_SCN_ALIGN_4096BYTES            0x00D00000 
#define IMAGE_SCN_ALIGN_8192BYTES            0x00E00000 
#define IMAGE_SCN_LNK_NRELOC_OVFL            0x01000000 // </FONT><FONT SIZE="2" FACE="Arial">Section contains extended relocations.</FONT><FONT
SIZE="2" FACE="Courier New">
#define IMAGE_SCN_MEM_DISCARDABLE            0x02000000 // </FONT><FONT SIZE="2" FACE="Arial">Section can be discarded.</FONT><FONT
SIZE="2" FACE="Courier New">
#define IMAGE_SCN_MEM_NOT_CACHED             0x04000000 // </FONT><FONT SIZE="2" FACE="Arial">Section is not cachable.</FONT><FONT
SIZE="2" FACE="Courier New">
#define IMAGE_SCN_MEM_NOT_PAGED              0x08000000 // </FONT><FONT SIZE="2" FACE="Arial">Section is not pageable.</FONT><FONT
SIZE="2" FACE="Courier New">
#define IMAGE_SCN_MEM_SHARED                 0x10000000 // </FONT><FONT SIZE="2" FACE="Arial">Section is shareable.</FONT><FONT
SIZE="2" FACE="Courier New">
#define IMAGE_SCN_MEM_EXECUTE                0x20000000 // </FONT><FONT SIZE="2" FACE="Arial">Section is executable.</FONT><FONT
SIZE="2" FACE="Courier New">
#define IMAGE_SCN_MEM_READ                   0x40000000 // </FONT><FONT SIZE="2" FACE="Arial">Section is readable.</FONT><FONT
SIZE="2" FACE="Courier New">
#define IMAGE_SCN_MEM_WRITE                  0x80000000 // </FONT><FONT SIZE="2" FACE="Arial">Section is writeable.</FONT></PRE>
<P><FONT SIZE="2" FACE="Arial">&quot;Nous allons avoir besoin de ProcDump ici pour nous donner l'Entry Point en
virtual offset de ART.<BR>
Lancer Pdump =&gt; PE Editor =&gt; charger ART.EXE =&gt; Entry Point : 499B9 (ceci est le virtual offset, bref
c'est l'offset en m&eacute;moire et si vous voulez conna&icirc;tre l'adresse, vous ajoutez l'Image Base = 400000,
ce qui nous donne 4499B9 comme Entry Point en m&eacute;moire). <BR>
Pourquoi fait-on &ccedil;a ? Pour savoir dans quelle section se trouve l'Entry Point.<BR>
Allez maintenant dans SECTION et regardez la colonne &quot; virtual offset &quot;.<BR>
499B9 se trouve dans .CODE car 499B9 est &gt; 1000 (le d&eacute;but de la section .CODE) et est &lt; 86000 (le
d&eacute;but de la section .DATA).<BR>
Voil&agrave; une bonne chose … maintenant regardons les attributs de la section .CODE<BR>
Cliquez avec le bouton de droite de la souris sur CODE (colonne NAME toujours dans ProcDump of course ) et choisissez
EDIT.<BR>
En bas, &agrave; droite se trouvent les &quot; Section Characteristics &quot; (= les attributs) qui valent : C00000040
qui, si on se r&eacute;f&egrave;rent &agrave; notre tableau ci-dessus veut dire : readable (40000000 =&gt; acc&egrave;s
en lecture) + writable (80000000 =&gt; acc&egrave;s en &eacute;criture =&gt; c'est typique des exe compress&eacute;s,
les programmes habituels prot&egrave;gent leur code en ne permettant pas l'&eacute;criture DANS le code, contrairement
&agrave; la section DATA o&ugrave; on peut lire et &eacute;crire) + Init Data (00000040) = C0000040.<BR>
Si vous regardez de plus pr&egrave;s la liste, vous d&eacute;couvrirez deux choses int&eacute;ressantes : 20000000
(ex&eacute;cutable) et 00000020 (contient du code).<BR>
Maintenant, si on disait que notre section doit &ecirc;tre 20000000 + 40000000+ 80000000 + 00000020 = E00000020
?<BR>
Changeons C0000040 en E0000020 et quittons ProcDump.<BR>
Essayez maintenant de d&eacute;sassembler ART.EXE avec Wdasm … vi vi &ccedil;a marche !<BR>
Cliquons sur l'ic&ocirc;ne PEP et on arrive &agrave; l'Entry Point (4499B9), allez sur cette ligne et vous verrez
tout en-bas @48DB9 (vous savez bien, le truc que vous regardez pour savoir o&ugrave; patcher …) et bien c'est le
&quot; raw Offset &quot;.</FONT></P>
<P><FONT SIZE="2" FACE="Arial"><BR>
</FONT><U><B><FONT SIZE="2" FACE="Arial">La m&ecirc;me chose vue sous l'angle de TeeJi</FONT></B></U></P>
<P><FONT SIZE="2" FACE="Arial">Chaque caract&eacute;ristique &agrave; une valeur. Si vous voulez avoir deux caract&eacute;ristiques,
vous faites : caract1 OR caract2 ... <BR>
Donc, pour que Softice break &agrave; l'entrypoint, il faut que la section qui contient la premi&egrave;re instruction
ait les caract&eacute;ristiques suivantes :</FONT></P>
<PRE><FONT SIZE="2" FACE="Courier New">   0x00000020 IMAGE_SCN_CNT_CODE 
   0x20000000 IMAGE_SCN_MEM_EXECUTE 
   0x40000000 IMAGE_SCN_MEM_READ 
OR 0x80000000 IMAGE_SCN_MEM_WRITE 
----------------------------------- 
   0xE0000020 </FONT></PRE>
<PRE><FONT SIZE="2" FACE="Arial">Et g&eacute;n&eacute;ralement, pour emp&ecirc;cher le break et le d&eacute;sassemblage de la section, on met les caract&eacute;ristiques suivantes : </FONT></PRE>
<PRE><FONT SIZE="2" FACE="Arial">       </FONT><FONT SIZE="2" FACE="Courier New">0x00000040 IMAGE_SCN_CNT_INITIALIZED_DATA 
   0x40000000 IMAGE_SCN_MEM_READ 
OR 0x80000000 IMAGE_SCN_MEM_WRITE 
-------------------------------------------- 
   0xC0000040 </FONT></PRE>
<P><FONT SIZE="2" FACE="Arial">Maintenant que l'on connait les caract&eacute;ristiques &agrave; changer, il nous
faut savoir quelle section contient l'entrypoint. Pour cela : <BR>
&middot; Lancer ProcDump ( ou n'importe quel Editeur de PE ) <BR>
&middot; Clicker sur [PE Editor] <BR>
&middot; Choisir le fichier compress&eacute; ( ou celui dont on veux modifier les caract&eacute;ristiques ) <BR>
&middot; Regarder la valeur de l'entry point <BR>
&middot; Cliquer sur [Section] <BR>
&middot; Regarder la colonne des Virtual Offset <BR>
&middot; Et la section qui contient l'Entry Point est celle qui commence avant l'entrypoint et qui est le plus
proche de celui-ci. <BR>
&middot; Vous cliquez sur la section avec le bouton droit et vous s&eacute;lectionn&eacute; Edit Section <BR>
&middot; et dans les caract&eacute;ristiques vous mettez E0000020 <BR>
&middot; OK / OK / FIN</FONT></P>
<P><U><B><FONT SIZE="2" FACE="Arial">D’autres explications</FONT></B></U><FONT SIZE="2" FACE="Arial"> (extrait
de Awave 5.0 de CyberBobJr)</FONT></P>
<PRE><FONT SIZE="2" FACE="Arial"></FONT></PRE>
<P><FONT SIZE="2" FACE="Arial">&quot;&nbsp;Arriv&eacute; &agrave; ce niveau, il est n&eacute;cessaire de savoir
comment fonctionne (vaguement ;) le format PE ... <BR>
Il faut savoir qu’un programme est divis&eacute; en sections, et chaque section poss&egrave;de une entr&eacute;e
dans le PE Header, ca veut dire que le code de d&eacute;cryptage poss&egrave;de une section dans le PE Header,
ProcDump nous permet d’avoir les d&eacute;tails de cette section :&nbsp;&quot;</FONT></P>
<CENTER>
<P>
<TABLE BORDER="1" CELLSPACING="1" WIDTH="598">
	<TR>
		<TD WIDTH="12%" VALIGN="MIDDLE">&nbsp;</TD>
		<TD WIDTH="25%" VALIGN="MIDDLE">
			<P ALIGN="CENTER"><FONT SIZE="2">Virtual size</FONT>
		</TD>
		<TD WIDTH="29%" VALIGN="MIDDLE">
			<P ALIGN="CENTER"><FONT SIZE="2">Virtual Offset</FONT>
		</TD>
		<TD WIDTH="17%" VALIGN="MIDDLE">
			<P ALIGN="CENTER"><FONT SIZE="2">Raw size</FONT>
		</TD>
		<TD WIDTH="17%" VALIGN="MIDDLE">
			<P ALIGN="CENTER"><FONT SIZE="2">Raw Offset</FONT>
		</TD>
	</TR>
	<TR>
		<TD WIDTH="12%" VALIGN="MIDDLE"><FONT SIZE="2">.data</FONT></TD>
		<TD WIDTH="25%" VALIGN="MIDDLE">
			<P ALIGN="CENTER"><FONT SIZE="2">00002000</FONT>
		</TD>
		<TD WIDTH="29%" VALIGN="MIDDLE">
			<P ALIGN="CENTER"><FONT SIZE="2">000DF000</FONT>
		</TD>
		<TD WIDTH="17%" VALIGN="MIDDLE">
			<P ALIGN="CENTER"><FONT SIZE="2">00001400</FONT>
		</TD>
		<TD WIDTH="17%" VALIGN="MIDDLE">
			<P ALIGN="CENTER"><FONT SIZE="2">00050A00</FONT>
		</TD>
	</TR>
</TABLE>
</P>
</CENTER>
<P><FONT SIZE="2" FACE="Arial">&quot;&nbsp;La taille virtuelle de notre code est 2000, ce qui veut dire qu'en RAM,
la m&eacute;moire allou&eacute;e pour notre code est de taille 0x2000 octets, ce qui toujours un multiple de la
page (en particulier i&ccedil;i 0x1000), en effet, la m&eacute;moire allou&eacute;e doit toujours &ecirc;tre multiple
de l'offset virtuel de la section CODE. <BR>
L'offset virtuel de notre code est de 000DF000, additionn&eacute; &agrave; l'image de base (00400000), ca nous
donne une adresse virtuelle de 004DF000 (et comme par hasard, cette adresse nous m&egrave;ne droit vers l'EIP du
programme&nbsp;? en l'occurence Awave 5.0). <BR>
La taille sur disque (Raw Size) est de 0x1400, ce qui veut dire que le code n'utilise que 0x1400 octets dans le
fichier .exe. <BR>
L'offset sur disque (Raw Offset) est de 00050A00, autrement dit le code s'&eacute;tale sur le disque de l'offset
0050A00 jusqu'a (0050A00+1400)=0051E00&nbsp;&quot;.</FONT></P>
<P><FONT SIZE="2" FACE="Arial"><BR>
</FONT><U><B><FONT SIZE="2" FACE="Arial">Et celles de Br&eacute;nuche dans Adanced Zip Password revovery</FONT></B></U></P>

<BLOCKQUOTE>
	<PRE><FONT SIZE="2" FACE="Courier New">Name    VirtualSize  VirtualOffset Raw Size Raw Offset Characteristics</FONT></PRE>
	<PRE><FONT SIZE="2" FACE="Courier New">.text     000AF000     00001000    0004AA00  00000600   C0000040
.data     0004B000     000B0000    00003E00  0004B000   C0000040
.tls      00001000     000FB000    00000200  0004EE00   C0000040
.rdata    00001000     000FC000    00000200  0004F000   C0000040
.idata    00003000     000FD000    00001200  0004F200   C0000040
.edata    00016000     00100000    00015800  00050400   C0000040
.rsrc     00044000     00116000    00020A00  00065C00   C0000040
.reloc    0000D000     0015A000    00000000  00086600   C0000040
.adata    0000F000     00167000    0000E200  00086600   C0000040
.udata    00001000     00176000    00000000  00094800   C0000040</FONT></PRE>
</BLOCKQUOTE>

<P><I><FONT SIZE="2" FACE="Arial">&quot;&nbsp;ProcDump32</FONT></I><FONT SIZE="2" FACE="Arial"> affiche les sections
du fichier dans l'ordre (cad par rapport &agrave; leur offset). La taille virtuelle (virtual) des sections correspond
au code r&eacute;el, celui qui sera en m&eacute;moire. Tandis que la taille brute (raw) correspond &agrave; l'espace
pris par cette section sur le disque dur (c'est ces donn&eacute;es qui nous int&eacute;ressent). Notez au passage
que la taille virtuelle est beaucoup plus grande que la taille brute, (compte tenu que le code d&eacute;compress&eacute;
doit &ecirc;tre &eacute;cris dans la m&ecirc;me section que celle qui contient le code compress&eacute;, cette
section doit &ecirc;tre grande en m&eacute;moire mais petite sur disque ) Ca, c'est le propre des exe compress&eacute;s.&nbsp;&quot;</FONT>
<br>
<br>
Christal.
</BODY>

</HTML>